<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-siteapp">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
    
    <meta name="referrer" content="no-referrer-when-downgrade">
    
    <meta name="renderer" content="webkit"/>
    <meta name="force-rendering" content="webkit"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
    <script>if (/*@cc_on!@*/false || (!!window.MSInputMethodContext && !!document.documentMode)) window.location.href="https://support.dmeng.net/upgrade-your-browser.html?referrer="+encodeURIComponent(window.location.href); </script>
    
    
        <link rel="preload" crossorigin="crossorigin" href="/fonts/roboto/Roboto-Regular.woff2" as="font">
        <link rel="preload" crossorigin="crossorigin" href="/fonts/roboto/Roboto-Bold.woff2" as="font">
    
    
    
        <link rel="shortcut icon" href="/icons/favicon.ico">
    

    
    
        
<link rel="stylesheet" href="/css/mdui.min.v1.0.0.css">

    
    
<link rel="stylesheet" href="/css/main.css">
<link rel="stylesheet" href="/css/iconfont.css">


    
    












          


    
    
    <title>
        
            VT 技术学习 | Hexo
        
    </title>
    
    
<meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
</head>
<body class="mdui-drawer-body-left mdui-appbar-with-toolbar mdui-theme-primary-teal mdui-theme-accent-blue">
  
  <header class="mdui-appbar mdui-appbar-fixed">
  <div id="toolbar" class="mdui-toolbar mdui-color-theme">
    <button class="mdui-btn mdui-btn-icon" mdui-drawer="{target: '#sidebar', swipe: true}"><i class="iconfont icon-menu"></i></button>
    <a href="/" class="mdui-typo-headline">Hexo</a>
    <a href="/" class="header-subtitle mdui-typo-headline"></a>
    <div class="mdui-toolbar-spacer"></div>
    <button class="mdui-btn mdui-btn-icon" mdui-dialog="{target: '#search'}" mdui-tooltip="{content: 'search'}"><i class="iconfont icon-search"></i></button>
  </div>
</header>

<div class="mdui-dialog" id="search">
  
    <div class="search-form">
      <input type="search" class="search-form-input" placeholder="请输入关键字" onfocus="listenSearchFunc()">
    </div>
    <div class="search-result" data-resource="/search.xml"></div>
  
</div>

  <aside id="sidebar" class="mdui-drawer">
    <div class="mdui-tab" mdui-tab>
        <a href="#sidebar-tab1" id="sidebartab" class="mdui-ripple mdui-tab-active">站点概览</a>
        <a href="#sidebar-tab2" id="sidebartab" class="mdui-ripple">关于</a>
    </div>

    
    <div id="sidebar-tab1" class="mdui-p-a-2">
        <div class="mdui-list">
            
                
                <a href="/" class="mdui-list-item mdui-ripple">
                    <div class="mdui-list-item-icon">
                        <i class="iconfont icon-home"></i>
                    </div>
                    <div class="mdui-list-item-content">主页</div>
                </a>
            
                
                <a href="/tags/" class="mdui-list-item mdui-ripple">
                    <div class="mdui-list-item-icon">
                        <i class="iconfont icon-bookmark"></i>
                    </div>
                    <div class="mdui-list-item-content">标签</div>
                </a>
            
                
                <a href="/categories/" class="mdui-list-item mdui-ripple">
                    <div class="mdui-list-item-icon">
                        <i class="iconfont icon-folder"></i>
                    </div>
                    <div class="mdui-list-item-content">分类</div>
                </a>
            
                
                <a href="/archives/" class="mdui-list-item mdui-ripple">
                    <div class="mdui-list-item-icon">
                        <i class="iconfont icon-archive"></i>
                    </div>
                    <div class="mdui-list-item-content">归档</div>
                </a>
            
                
                <a href="/tools/" class="mdui-list-item mdui-ripple">
                    <div class="mdui-list-item-icon">
                        <i class="iconfont icon-tools"></i>
                    </div>
                    <div class="mdui-list-item-content">工具箱</div>
                </a>
            
                
                <a href="/about/" class="mdui-list-item mdui-ripple">
                    <div class="mdui-list-item-icon">
                        <i class="iconfont icon-user"></i>
                    </div>
                    <div class="mdui-list-item-content">关于</div>
                </a>
            
            <div class="mdui-list-item mdui-ripple">
                <div class="mdui-list-item-icon">
                    <i class="iconfont icon-moon"></i>
                </div>
                <div class="mdui-list-item-content">夜间模式</div>
                <label class="mdui-switch" id="darkmode">
                  <input type="checkbox" id="nightmode_switch"/>
                  <i class="mdui-switch-icon"></i>
                </label>
            </div>           
        </div>
    </div>

    
    <div id="sidebar-tab2" class="mdui-p-a-2">
        <div class="sidebar-overview">
            <div class="sidebar-avatar">
                
                    <img src="/icons/avatar.gif"/>
                
            </div>
            <div class="sidebar-author-name">Gyan</div>
            <div class="sidebar-description"></div>
        </div>
        <div class="sidebar-links">
            
                
                <div class="mdui-chip">
                    <span class="mdui-chip-icon"><i class="iconfont icon-mail"></i></span>
                    <a href="mailto:Gy4n@protonmail.com" class="mdui-chip-title">E-Mail</a>
                </div>
            
                
                <div class="mdui-chip">
                    <span class="mdui-chip-icon"><i class="iconfont icon-github"></i></span>
                    <a target="_blank" rel="noopener" href="https://github.com/Gy4n" class="mdui-chip-title">GitHub</a>
                </div>
            
        </div>
        <ul class="mdui-list" mdui-collapse="{accordion: true}">
            <li class="mdui-collapse-item">
                <div class="mdui-collapse-item-header mdui-list-item mdui-ripple">
                    <div class="mdui-list-item-icon">
                        <i class="iconfont icon-link"></i>
                    </div>
                    <div class="mdui-list-item-content">友情链接</div>
                    <div class="mdui-collapse-item-arrow">
                        <i class="mdui-list-item-icon iconfont icon-angle-down"></i>
                    </div>
                </div>
                <ul id="linksList" class="mdui-collapse-item-body mdui-list mdui-list-dense">
                    
                </ul>
            </li>
        </ul>
    </div>

    <div class="mdui-divider"></div>
    
    
</aside>
  
  <main id="main-contain" class="mdui-container mdui-m-t-5">
    <article id="article" class="mdui-card mdui-p-b-2 mdui-m-b-5">
  <header class="mdui-card-media">
    
    
      <div class="post-header"> 
  <a class="post-header-title" href="/VT-%E6%8A%80%E6%9C%AF%E5%AD%A6%E4%B9%A0/">VT 技术学习</a>
  <div class="post-header-meta">
    <span>
      <span class="iconfont icon-calendar"></span>
      发布于:&nbsp;2023-02-05
    </span>
    <span>
      <span class="iconfont icon-calendar-check"></span>
      更新于:&nbsp;2023-05-16
    </span>
    <span>
      <span class="iconfont icon-folder"></span>
      分类于:&nbsp;
    </span>
    
  </div>
</div>   
    



    
    
    <div class="mdui-card-menu">
    
      <button class="mdui-btn mdui-btn-icon mdui-text-color-teal" mdui-menu="{target: '#share_menu', align: 'right'}"><i class="iconfont icon-share"></i></button>
      <ul class="mdui-menu" id="share_menu">
        <li class="mdui-menu-item">
          <a href="http://service.weibo.com/share/share.php?appkey=&title=VT 技术学习&url=https://gy4n.github.io/VT-%E6%8A%80%E6%9C%AF%E5%AD%A6%E4%B9%A0/&pic=https://gy4n.github.io/null&searchPic=false&style=simple" target="_blank" class="mdui-ripple">分享到 Weibo</a>
        </li>
        <li class="mdui-menu-item">
          <a href="https://twitter.com/intent/tweet?text=VT 技术学习&url=https://gy4n.github.io/VT-%E6%8A%80%E6%9C%AF%E5%AD%A6%E4%B9%A0/&via=Gyan" target="_blank" class="mdui-ripple">分享到 Twitter</a>
        </li>
        <li class="mdui-menu-item">
          <a href="https://www.facebook.com/sharer/sharer.php?u=https://gy4n.github.io/VT-%E6%8A%80%E6%9C%AF%E5%AD%A6%E4%B9%A0/" target="_blank" class="mdui-ripple">分享到 Facebook</a>
        </li>
        <li class="mdui-menu-item">
          <a href="https://plus.google.com/share?url=https://gy4n.github.io/VT-%E6%8A%80%E6%9C%AF%E5%AD%A6%E4%B9%A0/" target="_blank" class="mdui-ripple">分享到 Google+</a>
        </li>
        <li class="mdui-menu-item">
          <a href="https://www.linkedin.com/shareArticle?mini=true&url=https://gy4n.github.io/VT-%E6%8A%80%E6%9C%AF%E5%AD%A6%E4%B9%A0/&title=VT 技术学习" target="_blank" class="mdui-ripple">分享到 LinkedIn</a>
        </li>
        <li class="mdui-menu-item">
          <a href="http://connect.qq.com/widget/shareqq/index.html?site=Hexo&title=VT 技术学习&summary=&pics=https://gy4n.github.io/null&url=https://gy4n.github.io/VT-%E6%8A%80%E6%9C%AF%E5%AD%A6%E4%B9%A0/" target="_blank" class="mdui-ripple">分享到 QQ</a>
        </li>
        <li class="mdui-menu-item">
          <a href="https://telegram.me/share/url?url=https://gy4n.github.io/VT-%E6%8A%80%E6%9C%AF%E5%AD%A6%E4%B9%A0/&text=VT 技术学习" target="_blank" class="mdui-ripple">分享到 Telegram</a>
        </li>
      </ul>
    
  </div>
  </header>
  
  
  
  
  <div class="post-tags">
    
      <i class="iconfont icon-tag">
        <a rel="tag" href = /tags/VT/ >VT</a>
      </i>
    
  </div>

  
  <div class="mdui-card-content mdui-typo mdui-p-x-4">
    <p>VT技术入门。</p>
<span id="more"></span>

<h3 id="0x00-VT-技术介绍"><a href="#0x00-VT-技术介绍" class="headerlink" title="0x00 VT 技术介绍"></a>0x00 VT 技术介绍</h3><h3 id="0x01-VT-环境搭建"><a href="#0x01-VT-环境搭建" class="headerlink" title="0x01 VT 环境搭建"></a>0x01 VT 环境搭建</h3><p>在最新的Windows环境上，可能需要关闭<code>Hyper-V</code>，才能在VMware的虚拟机配置-处理器-虚拟化引擎中选中<code>Intel VT-x/EPT</code></p>
<p>如果开启了Virtualization Based Security（基于虚拟化的安全性），请先关闭它</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reg ADD HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\DeviceGuard /v EnableVirtualizationBasedSecurity /t REG_DWORD /d 0 /f</span><br></pre></td></tr></table></figure>

<p>再关闭<code>Hyper-V</code></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bcdedit /<span class="built_in">set</span> hypervisorlaunchtype off</span><br></pre></td></tr></table></figure>

<p>如果只关闭Hyper-V，不关闭VBS，Hyper-V是关不掉的。<br>如果还开启了UEFI 锁等复杂情况，就要参考微软文档了。</p>
<h3 id="0x02-总体流程"><a href="#0x02-总体流程" class="headerlink" title="0x02 总体流程"></a>0x02 总体流程</h3><h3 id="0x03-前置工作"><a href="#0x03-前置工作" class="headerlink" title="0x03 前置工作"></a>0x03 前置工作</h3><h4 id="CPUID"><a href="#CPUID" class="headerlink" title="CPUID"></a>CPUID</h4><p><code>eax = 1</code>执行<code>CPUID</code>，<code>ecx[5] = 1</code>则支持VT-x</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> ret[<span class="number">4</span>];</span><br><span class="line"></span><br><span class="line">	__cpuid(ret, <span class="number">1</span>);</span><br><span class="line">	<span class="comment">// 检查是否支持VT</span></span><br><span class="line">	<span class="keyword">if</span> (!(ret[<span class="number">2</span>] &amp; <span class="number">0x20</span>)) &#123; <span class="comment">// cpuid(1).ecx[5] == 1</span></span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<h4 id="msr"><a href="#msr" class="headerlink" title="msr"></a>msr</h4><p>检查VT-x是否在BIOS中被开启<br><code>msr[0x3a]</code>结果中的最低为为lock位，需要置1</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">uint64_t</span> msr = __readmsr(<span class="number">0x3a</span>);</span><br><span class="line"><span class="keyword">if</span> (!(msr &amp; <span class="number">1</span>)) &#123; <span class="comment">//  msr[0x3a].lock == 1</span></span><br><span class="line">    <span class="keyword">return</span> FALSE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="CR4"><a href="#CR4" class="headerlink" title="CR4"></a>CR4</h4><p><code>CR4</code>中的第13位<code>VMXE</code>置1打开启用<code>VMXE</code>指令扩展</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">uintptr_t</span> cr4 = __readcr4();</span><br><span class="line"><span class="comment">// 检查VT-x 是否已经开启</span></span><br><span class="line"><span class="keyword">if</span> (cr4 &amp; <span class="number">0x2000</span>) &#123; <span class="comment">//cr4.VMXE == 0</span></span><br><span class="line">	<span class="keyword">return</span> FALSE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="0x04-VMXON"><a href="#0x04-VMXON" class="headerlink" title="0x04 VMXON"></a>0x04 VMXON</h3><h4 id="启用VMX扩展"><a href="#启用VMX扩展" class="headerlink" title="启用VMX扩展"></a>启用VMX扩展</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="keyword">inline</span> <span class="title function_">EnableVMXE</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">uint32_t</span> cr4 = __readcr4();</span><br><span class="line">	cr4 &amp;= ~<span class="number">0x2000</span>;</span><br><span class="line">	__writecr4(cr4);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="分配VMXON-区域"><a href="#分配VMXON-区域" class="headerlink" title="分配VMXON 区域"></a>分配VMXON 区域</h4><p>直接分配4k即可</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PHYSICAL_ADDRESS HighAddress = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">g_cpu.pVMXONRegion = ExAllocatePoolWithTag(NonPagedPool, <span class="number">0x1000</span>, <span class="string">&#x27;vmon&#x27;</span>);</span><br><span class="line">g_cpu.pVMXONRegion_PA = MmGetPhysicalAddress(g_cpu.pVMXONRegion);</span><br><span class="line">RtlZeroMemory(g_cpu.pVMXONRegion, <span class="number">0x1000</span>);</span><br></pre></td></tr></table></figure>

<h4 id="设置VMXON区域"><a href="#设置VMXON区域" class="headerlink" title="设置VMXON区域"></a>设置VMXON区域</h4><p>设置VMXON区域的四字节为msr[0x480]的低32位</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">uintptr_t</span> msr = __readmsr(<span class="number">0x480</span>);</span><br><span class="line">*(ULONG*)(g_cpu.pVMXONRegion) = msr &amp; <span class="number">0xffffffff</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>执行<code>VMXON</code>指令，出错则CF位置1</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">push _high</span><br><span class="line">push _low</span><br><span class="line">vmxon dword ptr [esp]</span><br><span class="line">setc eax</span><br><span class="line">add esp,8</span><br></pre></td></tr></table></figure>

<h3 id="0x05-VMCS"><a href="#0x05-VMCS" class="headerlink" title="0x05  VMCS"></a>0x05  VMCS</h3><p>VMCS是<code>Virtual Machine Control Structure</code>，描述VM的一些属性。</p>
<p>首先需要初始化VMCS，再选中此VMCS。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 初始化虚拟机</span></span><br><span class="line">__vmx_vmclear(*(<span class="type">uint64_t</span>*)(&amp;g_cpu.pVMCSRegion_PA));</span><br><span class="line"><span class="comment">// 选中此虚拟机</span></span><br><span class="line">__vmx_vmptrld(*(<span class="type">uint64_t</span>*)(&amp;g_cpu.pVMCSRegion_PA));</span><br></pre></td></tr></table></figure>

<p>Intel 弄了一个标准的汇编指令来读写VMCS，<code>vmwrite/vmread</code>，不推荐直接修改内存。</p>
<p>VMCS域 包括以下三方面的内容：</p>
<p>1.宿主机执行域</p>
<p>2.虚拟机执行域</p>
<p>3.虚拟机执行控制域</p>
<p>3.1 VM 执行控制(<code>#VMExit</code> 事件设置)44</p>
<p>3.2 VM 退出控制(<code>#VMExit</code> 保存内容设置)</p>
<p>3.3 VM 进入控制(进入<code>#VMEntry</code> 加载设置)</p>
<ul>
<li><p>宿主机执行域</p>
<p>获取段描述符基址</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">PVOID <span class="title function_">GetSegmentDescriptor</span><span class="params">(<span class="type">uint16_t</span> index)</span></span><br><span class="line">&#123;</span><br><span class="line">	KGDTENTRY* GdtEntry = Asm_GetGdtBase();</span><br><span class="line">	KGDTENTRY TargetEntry = GdtEntry[index &gt;&gt; <span class="number">3</span>];</span><br><span class="line">	<span class="type">uintptr_t</span> ret = TargetEntry.HighWord.Bytes.BaseHi;</span><br><span class="line">	ret &lt;&lt;= <span class="number">8</span>;</span><br><span class="line">	ret |= TargetEntry.HighWord.Bytes.BaseMid;</span><br><span class="line">	ret &lt;&lt;= <span class="number">16</span>;</span><br><span class="line">	ret |= TargetEntry.BaseLow;</span><br><span class="line">	<span class="keyword">return</span> (PVOID)ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>HOST_RSP</code>的值，需要提前申请 </p>
<p><code>&amp; 0xfff8</code>必须清除RPL，和<code>TI</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">__vmx_vmwrite(HOST_CR0, __readcr0());</span><br><span class="line">__vmx_vmwrite(HOST_CR3, __readcr3());</span><br><span class="line">__vmx_vmwrite(HOST_CR4, __readcr4());</span><br><span class="line"></span><br><span class="line">__vmx_vmwrite(HOST_ES_SELECTOR, GetES() &amp; <span class="number">0xFFF8</span>);</span><br><span class="line">__vmx_vmwrite(HOST_CS_SELECTOR, GetCS() &amp; <span class="number">0xFFF8</span>);</span><br><span class="line">__vmx_vmwrite(HOST_DS_SELECTOR, GetDS() &amp; <span class="number">0xFFF8</span>);</span><br><span class="line">__vmx_vmwrite(HOST_FS_SELECTOR, GetFS() &amp; <span class="number">0xFFF8</span>);</span><br><span class="line">__vmx_vmwrite(HOST_GS_SELECTOR, GetGS() &amp; <span class="number">0xFFF8</span>);</span><br><span class="line">__vmx_vmwrite(HOST_SS_SELECTOR, GetSS() &amp; <span class="number">0xFFF8</span>);</span><br><span class="line">__vmx_vmwrite(HOST_TR_SELECTOR, GetTR() &amp; <span class="number">0xFFF8</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// KGDTENTRY* GdtEntry = Asm_GetGdtBase();</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">__vmx_vmwrite(HOST_TR_BASE, <span class="number">0x80042000</span>);</span><br><span class="line"></span><br><span class="line">__vmx_vmwrite(HOST_GDTR_BASE, Asm_GetGdtBase());</span><br><span class="line">__vmx_vmwrite(HOST_IDTR_BASE, Asm_GetIdtBase());</span><br><span class="line"></span><br><span class="line">__vmx_vmwrite(HOST_IA32_SYSENTER_CS, __readmsr(MSR_IA32_SYSENTER_CS) &amp; <span class="number">0xFFFFFFFF</span>);</span><br><span class="line">__vmx_vmwrite(HOST_IA32_SYSENTER_ESP, __readmsr(MSR_IA32_SYSENTER_ESP) &amp; <span class="number">0xFFFFFFFF</span>);</span><br><span class="line">__vmx_vmwrite(HOST_IA32_SYSENTER_EIP, __readmsr(MSR_IA32_SYSENTER_EIP) &amp; <span class="number">0xFFFFFFFF</span>); <span class="comment">// KiFastCallEntry</span></span><br><span class="line"></span><br><span class="line">__vmx_vmwrite(HOST_RSP, ((ULONG)g_VMXCPU.pStack) + <span class="number">0x2000</span>);     <span class="comment">//Host 临时栈</span></span><br><span class="line">__vmx_vmwrite(HOST_RIP, (ULONG)VMMEntryPoint);                  <span class="comment">//这里定义我们的VMM处理程序入口</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>很好，Intel你要提供<code>HOST_TR_BASE</code>，<code>HOST_FS_BASE</code>，<code>HOST_GS_BASE</code></p>
<p>如果要它的话需要在GDT表找，然后拼接基地址。</p>
<p>这里偷了一份KGDTEntry的结构</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">KGDTENTRY</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    USHORT LimitLow;                                                        <span class="comment">//0x0</span></span><br><span class="line">    USHORT BaseLow;                                                         <span class="comment">//0x2</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">        &#123;</span></span><br><span class="line">            UCHAR BaseMid;                                                  <span class="comment">//0x4</span></span><br><span class="line">            UCHAR Flags1;                                                   <span class="comment">//0x5</span></span><br><span class="line">            UCHAR Flags2;                                                   <span class="comment">//0x6</span></span><br><span class="line">            UCHAR BaseHi;                                                   <span class="comment">//0x7</span></span><br><span class="line">        &#125; Bytes;                                                            <span class="comment">//0x4</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">        &#123;</span></span><br><span class="line">            ULONG BaseMid : <span class="number">8</span>;                                                <span class="comment">//0x4</span></span><br><span class="line">            ULONG Type : <span class="number">5</span>;                                                   <span class="comment">//0x4</span></span><br><span class="line">            ULONG Dpl : <span class="number">2</span>;                                                    <span class="comment">//0x4</span></span><br><span class="line">            ULONG Pres : <span class="number">1</span>;                                                   <span class="comment">//0x4</span></span><br><span class="line">            ULONG LimitHi : <span class="number">4</span>;                                                <span class="comment">//0x4</span></span><br><span class="line">            ULONG Sys : <span class="number">1</span>;                                                    <span class="comment">//0x4</span></span><br><span class="line">            ULONG Reserved_0 : <span class="number">1</span>;                                             <span class="comment">//0x4</span></span><br><span class="line">            ULONG Default_Big : <span class="number">1</span>;                                            <span class="comment">//0x4</span></span><br><span class="line">            ULONG Granularity : <span class="number">1</span>;                                            <span class="comment">//0x4</span></span><br><span class="line">            ULONG BaseHi : <span class="number">8</span>;                                                 <span class="comment">//0x4</span></span><br><span class="line">        &#125; Bits;                                                             <span class="comment">//0x4</span></span><br><span class="line">    &#125; HighWord;                                                             <span class="comment">//0x4</span></span><br><span class="line">&#125; KGDTENTRY;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//0x10 bytes (sizeof)</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">union</span> _<span class="title">KGDTENTRY</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">        USHORT LimitLow;                                                    <span class="comment">//0x0</span></span><br><span class="line">        USHORT BaseLow;                                                     <span class="comment">//0x2</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">        UCHAR BaseMiddle;                                                   <span class="comment">//0x4</span></span><br><span class="line">        UCHAR Flags1;                                                       <span class="comment">//0x5</span></span><br><span class="line">        UCHAR Flags2;                                                       <span class="comment">//0x6</span></span><br><span class="line">        UCHAR BaseHigh;                                                     <span class="comment">//0x7</span></span><br><span class="line">    &#125; Bytes;                                                                <span class="comment">//0x4</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">        &#123;</span></span><br><span class="line">            ULONG BaseMiddle : <span class="number">8</span>;                                                 <span class="comment">//0x4</span></span><br><span class="line">            ULONG Type : <span class="number">5</span>;                                                       <span class="comment">//0x4</span></span><br><span class="line">            ULONG Dpl : <span class="number">2</span>;                                                        <span class="comment">//0x4</span></span><br><span class="line">            ULONG Present : <span class="number">1</span>;                                                    <span class="comment">//0x4</span></span><br><span class="line">            ULONG LimitHigh : <span class="number">4</span>;                                                  <span class="comment">//0x4</span></span><br><span class="line">            ULONG System : <span class="number">1</span>;                                                     <span class="comment">//0x4</span></span><br><span class="line">            ULONG LongMode : <span class="number">1</span>;                                                   <span class="comment">//0x4</span></span><br><span class="line">            ULONG DefaultBig : <span class="number">1</span>;                                                 <span class="comment">//0x4</span></span><br><span class="line">            ULONG Granularity : <span class="number">1</span>;                                                <span class="comment">//0x4</span></span><br><span class="line">            ULONG BaseHigh : <span class="number">8</span>;                                                   <span class="comment">//0x4</span></span><br><span class="line">        &#125; Bits;                                                                 <span class="comment">//0x4</span></span><br><span class="line">        ULONG BaseUpper;                                                    <span class="comment">//0x8</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">        ULONG MustBeZero;                                                   <span class="comment">//0xc</span></span><br><span class="line">        LONGLONG DataLow;                                                   <span class="comment">//0x0</span></span><br><span class="line">    &#125;;</span><br><span class="line">    LONGLONG DataHigh;                                                      <span class="comment">//0x8</span></span><br><span class="line">&#125;KGDTENTRY;</span><br></pre></td></tr></table></figure>
</li>
<li><p>虚拟机执行控制域</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">`GUEST_ES_AR_BYTES`为ES段的属性，设置为`0x10000`不可用。</span><br><span class="line"></span><br><span class="line">```c</span><br><span class="line">__vmx_vmwrite(GUEST_CR0, __readcr0());</span><br><span class="line">__vmx_vmwrite(GUEST_CR3, __readcr3());</span><br><span class="line">__vmx_vmwrite(GUEST_CR4, __readcr4());</span><br><span class="line"></span><br><span class="line">__vmx_vmwrite(GUEST_DR7, 0x400);</span><br><span class="line">__vmx_vmwrite(GUEST_RFLAGS, __readeflags() &amp; ~0x200); // IF = 0</span><br><span class="line"></span><br><span class="line">__vmx_vmwrite(GUEST_ES_SELECTOR, GetES() &amp; 0xFFF8);</span><br><span class="line">__vmx_vmwrite(GUEST_CS_SELECTOR, GetCS() &amp; 0xFFF8);</span><br><span class="line">__vmx_vmwrite(GUEST_DS_SELECTOR, GetDS() &amp; 0xFFF8);</span><br><span class="line">__vmx_vmwrite(GUEST_FS_SELECTOR, GetFS() &amp; 0xFFF8);</span><br><span class="line">__vmx_vmwrite(GUEST_GS_SELECTOR, GetGS() &amp; 0xFFF8);</span><br><span class="line">__vmx_vmwrite(GUEST_SS_SELECTOR, GetSS() &amp; 0xFFF8);</span><br><span class="line">__vmx_vmwrite(GUEST_TR_SELECTOR, GetTR() &amp; 0xFFF8);</span><br><span class="line"></span><br><span class="line">// 设置 Segment Unusable</span><br><span class="line">__vmx_vmwrite(GUEST_ES_AR_BYTES, 0x10000);</span><br><span class="line">__vmx_vmwrite(GUEST_FS_AR_BYTES, 0x10000);</span><br><span class="line">__vmx_vmwrite(GUEST_DS_AR_BYTES, 0x10000);</span><br><span class="line">__vmx_vmwrite(GUEST_SS_AR_BYTES, 0x10000);</span><br><span class="line">__vmx_vmwrite(GUEST_GS_AR_BYTES, 0x10000);</span><br><span class="line">__vmx_vmwrite(GUEST_LDTR_AR_BYTES, 0x10000);</span><br><span class="line"></span><br><span class="line">// 需要构造描述符线长、属性等，我要偷大懒</span><br><span class="line">// 在guest里面刷一下选择子</span><br><span class="line">__vmx_vmwrite(GUEST_CS_AR_BYTES, 0xc09b);</span><br><span class="line">__vmx_vmwrite(GUEST_CS_BASE, 0);</span><br><span class="line">__vmx_vmwrite(GUEST_CS_LIMIT, 0xffffffff);</span><br><span class="line"></span><br><span class="line">__vmx_vmwrite(GUEST_TR_AR_BYTES, 0x008b);</span><br><span class="line">__vmx_vmwrite(GUEST_TR_BASE, 0x80042000);</span><br><span class="line">__vmx_vmwrite(GUEST_TR_LIMIT, 0x20ab);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">__vmx_vmwrite(GUEST_GDTR_BASE, Asm_GetGdtBase());</span><br><span class="line">__vmx_vmwrite(GUEST_GDTR_LIMIT, Asm_GetGdtLimit());</span><br><span class="line">__vmx_vmwrite(GUEST_IDTR_BASE, Asm_GetIdtBase());</span><br><span class="line">__vmx_vmwrite(GUEST_IDTR_LIMIT, Asm_GetIdtLimit());</span><br><span class="line"></span><br><span class="line">__vmx_vmwrite(GUEST_IA32_DEBUGCTL, __readmsr(MSR_IA32_DEBUGCTL) &amp; 0xFFFFFFFF);</span><br><span class="line">__vmx_vmwrite(GUEST_IA32_DEBUGCTL_HIGH, __readmsr(MSR_IA32_DEBUGCTL) &gt;&gt; 32);</span><br><span class="line"></span><br><span class="line">__vmx_vmwrite(GUEST_SYSENTER_CS, __readmsr(MSR_IA32_SYSENTER_CS) &amp; 0xFFFFFFFF);</span><br><span class="line">__vmx_vmwrite(GUEST_SYSENTER_ESP, __readmsr(MSR_IA32_SYSENTER_ESP) &amp; 0xFFFFFFFF);</span><br><span class="line">__vmx_vmwrite(GUEST_SYSENTER_EIP, __readmsr(MSR_IA32_SYSENTER_EIP) &amp; 0xFFFFFFFF); // KiFastCallEntry</span><br><span class="line"></span><br><span class="line">__vmx_vmwrite(GUEST_RSP, ((ULONG)g_cpu.pStack) + 0x1000);     //Guest 临时栈</span><br><span class="line">__vmx_vmwrite(GUEST_RIP, (ULONG)GuestEntry);                     // 客户机的入口点</span><br><span class="line"></span><br><span class="line">// 物理地址意义上的nullptr</span><br><span class="line">__vmx_vmwrite(VMCS_LINK_POINTER, 0xffffffff);</span><br><span class="line">__vmx_vmwrite(VMCS_LINK_POINTER_HIGH, 0xffffffff);</span><br></pre></td></tr></table></figure>

<p><code>GuestEntry</code>是GUEST VM的入口点</p>
<p> <code>__vmx_vmread(VM_INSTRUCTION_ERROR)</code>@24.9.1</p>
<ul>
<li><p>VM 控制域</p>
<p>通过设置<code>Flags</code>标志位来控制VM的一些行为，Intel为了防止你写玩具VMM的时候把这段全填0，贴心的设置了一些预留位需要置1的位，真好。</p>
<p>通过查询MSR寄存器来了解哪些预留位为1，哪些为0</p>
<p>比如</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; rdmsr 481</span><br><span class="line">msr[481] = 0000003f`00000016</span><br><span class="line">kd&gt; .formats 0000003f`00000016</span><br><span class="line">Evaluate expression:</span><br><span class="line">  Hex:     0000003f`00000016</span><br><span class="line">  Decimal: 270582939670</span><br><span class="line">  Octal:   0000000003740000000026</span><br><span class="line">  Binary:  00000000 00000000 00000000 00111111 00000000 00000000 00000000 00010110</span><br><span class="line">  Chars:   ...?....</span><br><span class="line">  Time:    Mon Jan  1 15:30:58.293 1601 (UTC + 8:00)</span><br><span class="line">  Float:   low 3.08286e-044 high 8.82818e-044</span><br><span class="line">  Double:  1.33686e-312</span><br></pre></td></tr></table></figure>

<p>MSR值中前32位中二进制为0的位，设置对应域时该位必须为0</p>
<p>MSR值中后32位中二进制为1的位，设置对应域时该位必须为1</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ULONG <span class="title function_">VTAdjustExcuteControls</span><span class="params">(ULONG Value,ULONG msr)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">uint64_t</span> mask = __readmsr(msr);</span><br><span class="line">	Value &amp;= (mask &gt;&gt; <span class="number">32</span>);</span><br><span class="line">	Value |= (mask &amp; <span class="number">0xffffffff</span>);</span><br><span class="line">	<span class="keyword">return</span> Value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li><p>VM 执行控制</p>
<p><code>Pin-Based VM-Execution Controls</code> 基于CPU针脚的VM执行控制 （Intel 3a @24.6.1）</p>
<p>定义发生外部中断、NMI等的是否退出虚拟机。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__vmx_vmwrite(PIN_BASED_VM_EXEC_CONTROL, VTAdjustExcuteControls(<span class="number">0</span>, MSR_IA32_VMX_PINBASED_CTLS));</span><br></pre></td></tr></table></figure>

<p><code>Processor-Based VM-Execution Controls</code> 基于处理器的VM执行控制（Intel 3a @24.6.2）</p>
<p>定义执行一些CPU指令（<code>HLT/INVLPG/RDTSC/CR3切换/内部中断</code>）是否需要退出虚拟机</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__vmx_vmwrite(CPU_BASED_VM_EXEC_CONTROL, VTAdjustExcuteControls(<span class="number">0</span>, MSR_IA32_VMX_PROCBASED_CTLS));</span><br></pre></td></tr></table></figure>
</li>
<li><p>VM 退出控制 </p>
<p>Intel <a href="mailto:&#x33;&#x61;&#64;&#x32;&#52;&#46;&#x37;&#46;&#x31;">&#x33;&#x61;&#64;&#x32;&#52;&#46;&#x37;&#46;&#x31;</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__vmx_vmwrite(VM_EXIT_CONTROLS, VTAdjustExcuteControls(<span class="number">0</span>,MSR_IA32_VMX_EXIT_CTLS));</span><br></pre></td></tr></table></figure>
</li>
<li><p>VM 进入控制</p>
<p>Intel <a href="mailto:&#x33;&#97;&#x40;&#x32;&#x34;&#x2e;&#x37;&#x2e;&#x31;">&#x33;&#97;&#x40;&#x32;&#x34;&#x2e;&#x37;&#x2e;&#x31;</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__vmx_vmwrite(VM_ENTRY_CONTROLS, VTAdjustExcuteControls(<span class="number">0</span>, MSR_IA32_VMX_ENTRY_CTLS));</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h3 id="0x06-VM-启动"><a href="#0x06-VM-启动" class="headerlink" title="0x06 VM 启动"></a>0x06 VM 启动</h3><p>启动后，CPU会跳到<code>GUEST_RIP</code>，ESP设置为<code>GUEST_RSP</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">__asm&#123;</span><br><span class="line">    pushad</span><br><span class="line">    pushfd</span><br><span class="line">    mov guest_sp,esp</span><br><span class="line">    mov guest_ip, offset Ret</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// VMLANUCH 虚拟机启动，跳转到 GuestEntry 就不回来了</span></span><br><span class="line">__vmx_vmlaunch();</span><br><span class="line"><span class="comment">// 这条指令下的语句不会执行</span></span><br><span class="line">DbgPrint(<span class="string">&quot;VT Failed With Error Code: 0x%x&quot;</span>,__vmx_vmread(VM_INSTRUCTION_ERROR));</span><br><span class="line"><span class="comment">// 这里的Ret是用来接收跳转，正常返回</span></span><br><span class="line">Ret:</span><br><span class="line">	__asm&#123;</span><br><span class="line">		popfd</span><br><span class="line">		popad</span><br><span class="line">	&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>GuestEntry</code>的定义</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">__declspec(naked) <span class="type">void</span> <span class="title function_">GuestEntry</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	__asm &#123;</span><br><span class="line"></span><br><span class="line">		mov ax, es</span><br><span class="line">		mov es, ax</span><br><span class="line">	</span><br><span class="line">		mov ax, ds</span><br><span class="line">		mov ds, ax</span><br><span class="line">	</span><br><span class="line">		mov ax, fs</span><br><span class="line">		mov fs, ax</span><br><span class="line">	</span><br><span class="line">		mov ax, gs</span><br><span class="line">		mov gs, ax</span><br><span class="line">	</span><br><span class="line">		mov ax, ss</span><br><span class="line">		mov ss, ax</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	__asm &#123;</span><br><span class="line">	</span><br><span class="line">		mov esp, guest_sp</span><br><span class="line">		jmp guest_ip</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="0x06-VMExit"><a href="#0x06-VMExit" class="headerlink" title="0x06 #VMExit"></a>0x06 #VMExit</h3><p>当虚拟机执行到设置的<code>#VMExit</code>的指令后，会退出虚拟机，执行<code>HOST_RIP</code>函数。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">__declspec(naked) <span class="type">void</span> <span class="title function_">VMExitHandler</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	__asm &#123;</span><br><span class="line">		mov g_GuestRegs.eax, eax</span><br><span class="line">		mov g_GuestRegs.ecx, ecx</span><br><span class="line">		mov g_GuestRegs.edx, edx</span><br><span class="line">		mov g_GuestRegs.ebx, ebx</span><br><span class="line">		mov g_GuestRegs.esp, esp</span><br><span class="line">		mov g_GuestRegs.ebp, ebp</span><br><span class="line">		mov g_GuestRegs.esi, esi</span><br><span class="line">		mov g_GuestRegs.edi, edi</span><br><span class="line"></span><br><span class="line">		pushfd</span><br><span class="line">		pop eax</span><br><span class="line">		mov g_GuestRegs.eflags, eax</span><br><span class="line"></span><br><span class="line">		mov ax, fs</span><br><span class="line">		mov fs, ax</span><br><span class="line">		mov ax, gs</span><br><span class="line">		mov gs, ax</span><br><span class="line">	&#125;</span><br><span class="line">	VMExitHandlerDispatcher();</span><br><span class="line">	__asm &#123;</span><br><span class="line">		mov  eax, g_GuestRegs.eax</span><br><span class="line">		mov  ecx, g_GuestRegs.ecx</span><br><span class="line">		mov  edx, g_GuestRegs.edx</span><br><span class="line">		mov  ebx, g_GuestRegs.ebx</span><br><span class="line">		mov  esp, g_GuestRegs.esp</span><br><span class="line">		mov  ebp, g_GuestRegs.ebp</span><br><span class="line">		mov  esi, g_GuestRegs.esi</span><br><span class="line">		mov  edi, g_GuestRegs.edi</span><br><span class="line"></span><br><span class="line">		<span class="comment">//vmresume</span></span><br><span class="line">		__emit <span class="number">0x0f</span></span><br><span class="line">		__emit <span class="number">0x01</span></span><br><span class="line">		__emit <span class="number">0xc3</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>VMExitHandlerDispatcher</code>函数用于处理<code>#VMExit</code>事件：</p>
<p><code>ExitReason</code>指定了退出原因。</p>
<p><code>ExitInstructionLength</code>指定了导致退出指令的长度。</p>
<p><code>g_GuestRegs.eip = __vmx_vmread(GUEST_RIP);</code>读取了导致退出指令的地址。</p>
<p>处理完指令的退出后，设置<code>GUEST_RIP</code>为下一跳指令。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span>  <span class="title function_">VMExitHandlerDispatcher</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	ULONG ExitReason;</span><br><span class="line">	ULONG ExitInstructionLength;</span><br><span class="line">	ULONG GuestResumeEIP;</span><br><span class="line"></span><br><span class="line">	ExitReason = __vmx_vmread(VM_EXIT_REASON);</span><br><span class="line">	ExitInstructionLength = __vmx_vmread(VM_EXIT_INSTRUCTION_LEN);</span><br><span class="line"></span><br><span class="line">	g_GuestRegs.eflags = __vmx_vmread(GUEST_RFLAGS);</span><br><span class="line">	g_GuestRegs.esp = __vmx_vmread(GUEST_RSP);</span><br><span class="line">	g_GuestRegs.eip = __vmx_vmread(GUEST_RIP);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">switch</span> (ExitReason)</span><br><span class="line">	&#123;</span><br><span class="line">	<span class="keyword">case</span> EXIT_REASON_CPUID:</span><br><span class="line">		HandleCPUID();</span><br><span class="line">		Log(<span class="string">&quot;EXIT_REASON_CPUID&quot;</span>, <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">case</span> EXIT_REASON_VMCALL:</span><br><span class="line">		HandleVmCall();</span><br><span class="line">		Log(<span class="string">&quot;EXIT_REASON_VMCALL&quot;</span>, <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">case</span> EXIT_REASON_CR_ACCESS:</span><br><span class="line">		HandleCrAccess();</span><br><span class="line">		<span class="comment">//Log(&quot;EXIT_REASON_CR_ACCESS&quot;, 0)</span></span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">19</span>:</span><br><span class="line">	<span class="keyword">case</span> <span class="number">20</span>:</span><br><span class="line">	<span class="keyword">case</span> <span class="number">21</span>:</span><br><span class="line">	<span class="keyword">case</span> <span class="number">22</span>:</span><br><span class="line">	<span class="keyword">case</span> <span class="number">23</span>:</span><br><span class="line">	<span class="keyword">case</span> <span class="number">24</span>:</span><br><span class="line">	<span class="keyword">case</span> <span class="number">25</span>:</span><br><span class="line">	<span class="keyword">case</span> <span class="number">26</span>:</span><br><span class="line">	<span class="keyword">case</span> <span class="number">27</span>:</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		Log(<span class="string">&quot;not handled reason: %p&quot;</span>, ExitReason);</span><br><span class="line">		__asm <span class="type">int</span> <span class="number">3</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//Resume:</span></span><br><span class="line">	GuestResumeEIP = g_GuestRegs.eip + ExitInstructionLength;</span><br><span class="line">	__vmx_vmwrite(GUEST_RIP, GuestResumeEIP);</span><br><span class="line">	__vmx_vmwrite(GUEST_RSP, g_GuestRegs.esp);</span><br><span class="line">	__vmx_vmwrite(GUEST_RFLAGS, g_GuestRegs.eflags);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="0x07-EPT"><a href="#0x07-EPT" class="headerlink" title="0x07 EPT"></a>0x07 EPT</h3><p>看了一下要重建页表我就不想看了。</p>
<h3 id="0x08-代码"><a href="#0x08-代码" class="headerlink" title="0x08 代码"></a>0x08 代码</h3><p>这个代码魔改的周壑的<code>VT_Learn</code>，建议不要乱魔改，坑非常多。</p>

  </div>
  <!--文末结束语-->
  
    <div style="text-align:center;color: #ccc;font-size:24px;"> --- 我是有底线的 --- </div>
  
  <!--页脚广告-->
  
  <div class="mdui-divider"></div>
  
  <nav>
    
      <a rel="prev" class="post-nav-item mdui-float-left" href="/UEFI-MBR%E8%B0%83%E8%AF%95%E8%B8%A9%E5%9D%91%E5%90%88%E9%9B%86/">
        <i class="iconfont icon-angle-left"></i>
        <span>UEFI+MBR调试踩坑合集</span>
      </a>
    
    
      <a rel="next" class="post-nav-item mdui-float-right" href="/2022%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%91%E9%83%A8%E5%88%86%E9%A2%98%E7%9B%AEWriteup/">
        <span>2022西湖论剑部分题目Writeup</span>
        <i class="iconfont icon-angle-right"></i>
      </a>
    
  </nav>
</article>




  <div class="toc-button"  style="z-index: 100;">
    <button class="mdui-fab mdui-ripple mdui-color-teal" mdui-menu="{target: '#toc'}"><i class="iconfont icon-list"></i></button>
    <ul class="mdui-menu" id="toc">
      <li class="mdui-menu-item">
        <a href="/VT-%E6%8A%80%E6%9C%AF%E5%AD%A6%E4%B9%A0/" id="toc-header" class="mdui-ripple">文章目录</a>
        <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#0x00-VT-%E6%8A%80%E6%9C%AF%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.</span> <span class="toc-text">0x00 VT 技术介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x01-VT-%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-number">2.</span> <span class="toc-text">0x01 VT 环境搭建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x02-%E6%80%BB%E4%BD%93%E6%B5%81%E7%A8%8B"><span class="toc-number">3.</span> <span class="toc-text">0x02 总体流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x03-%E5%89%8D%E7%BD%AE%E5%B7%A5%E4%BD%9C"><span class="toc-number">4.</span> <span class="toc-text">0x03 前置工作</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#CPUID"><span class="toc-number">4.1.</span> <span class="toc-text">CPUID</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#msr"><span class="toc-number">4.2.</span> <span class="toc-text">msr</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CR4"><span class="toc-number">4.3.</span> <span class="toc-text">CR4</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x04-VMXON"><span class="toc-number">5.</span> <span class="toc-text">0x04 VMXON</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%AF%E7%94%A8VMX%E6%89%A9%E5%B1%95"><span class="toc-number">5.1.</span> <span class="toc-text">启用VMX扩展</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E9%85%8DVMXON-%E5%8C%BA%E5%9F%9F"><span class="toc-number">5.2.</span> <span class="toc-text">分配VMXON 区域</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AEVMXON%E5%8C%BA%E5%9F%9F"><span class="toc-number">5.3.</span> <span class="toc-text">设置VMXON区域</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x05-VMCS"><span class="toc-number">6.</span> <span class="toc-text">0x05  VMCS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x06-VM-%E5%90%AF%E5%8A%A8"><span class="toc-number">7.</span> <span class="toc-text">0x06 VM 启动</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x06-VMExit"><span class="toc-number">8.</span> <span class="toc-text">0x06 #VMExit</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x07-EPT"><span class="toc-number">9.</span> <span class="toc-text">0x07 EPT</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x08-%E4%BB%A3%E7%A0%81"><span class="toc-number">10.</span> <span class="toc-text">0x08 代码</span></a></li></ol>
      </li>
    </ul>
  </div>



    <div id="comment" class="mdui-card mdui-p-a-2 mdui-m-b-5">
      <div class="mdui-tab" mdui-tab>
        
          <a href="#comment-tab0" class="mdui-ripple">gitalk</a>
        
          <a href="#comment-tab1" class="mdui-ripple">livere</a>
        
      </div>
      
        <div id="comment-tab0" class="mdui-p-a-2">
          <div id="gitalk-container"></div>
<link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
<script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
<script src="//cdn.jsdelivr.net/npm/js-md5@0.7.3/src/md5.min.js"></script>
<script>
  var gitalk = new Gitalk({
    clientID: '',
    clientSecret: '',
    repo: '',
    owner: '',
    admin: [''],
    id:  md5(location.pathname) ,
    distractionFreeMode: 'true',
  });
  gitalk.render('gitalk-container');
</script>
        </div>
      
        <div id="comment-tab1" class="mdui-p-a-2">
          <div id="lv-container" data-id="city" data-uid="">
  <script type="text/javascript">
    (function (d, s) {
      var j, e = d.getElementsByTagName(s)[0];
      if (typeof LivereTower === 'function') { return; }
      j = d.createElement(s);
      j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
      j.async = true;
      e.parentNode.insertBefore(j, e);
    })(document, 'script');
  </script>
  <noscript>Please enable JavaScript to view the comments powered by LiveRe.</noscript>
</div>
        </div>
      
    </div>

  </main>
  <footer id="footer" class="mdui-text-center mdui-m-t-5 mdui-p-b-2 mdui-p-t-4 mdui-color-theme">
  <div class="mdui-container">
    <div class="mdui-row">
      
        <a href="https://beian.miit.gov.cn" rel="noopener" target="_blank"></a>
      
      <span>
        &copy; 2023 - 2023 
        
          <span style="color:#d9333f" class="iconfont icon-heart"></span>
        
        Gyan
      </span>
    </div>
    <div class="mdui-row">
      
        <div class="mdui-col-xs-6 mdui-text-right">
          <span>Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a></span>
        </div>
        <div class="mdui-col-xs-6 mdui-text-left">
          <span>Theme: <a href="https://github.com/kb1000fx/Meadow" rel="noopener" target="_blank">Meadow</a></span>
        </div>
      
    </div>
    <div class="mdui-row">
      
    </div>
 </div>
</footer>
  
  <button id="gotop" class="mdui-fab mdui-fab-fixed mdui-fab-hide mdui-ripple mdui-color-teal" style="z-index:100;"><i class="iconfont icon-arrowup"></i></button>
  
  




    <script src="https://cdn.jsdelivr.net/npm/mermaid@8.4.8/dist/mermaid.min.js"></script>
    <script>mermaid.initialize({
        startOnLoad: true,
        theme: "default"
    });</script>




    
<script src="/js/mdui.min.v1.0.0.js"></script>




<script src="/js/meadow.js"></script>

</body>
</html >